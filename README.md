<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Rails学習まとめ](#rails%E5%AD%A6%E7%BF%92%E3%81%BE%E3%81%A8%E3%82%81)
  - [改訂4版 基礎Ruby on Rails](#%E6%94%B9%E8%A8%824%E7%89%88-%E5%9F%BA%E7%A4%8Eruby-on-rails)
    - [例外処理](#%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86)
    - [allメソッド](#all%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [anyメソッド](#any%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [detectメソッド](#detect%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [find_allメソッド](#find_all%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [メソッドの引数にハッシュを取るとき](#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%BC%95%E6%95%B0%E3%81%AB%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E5%8F%96%E3%82%8B%E3%81%A8%E3%81%8D)
    - [ActiveSupport::TimeWithZoneクラスのインスタンス](#activesupporttimewithzone%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9)
    - [クラスメソッドの中のself](#%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E4%B8%AD%E3%81%AEself)
    - [リダイレクション](#%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3)
    - [findメソッドは引数を自動的に整数型に変換する](#find%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%E5%BC%95%E6%95%B0%E3%82%92%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AB%E6%95%B4%E6%95%B0%E5%9E%8B%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B)
    - [MD5のハッシュ化](#md5%E3%81%AE%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E5%8C%96)
    - [アクションでないメソッドをコントローラーに記述する場合はプライベートメソッドにしなければならない](#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A7%E3%81%AA%E3%81%84%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E3%81%AB%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AF%E3%83%97%E3%83%A9%E3%82%A4%E3%83%99%E3%83%BC%E3%83%88%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E3%81%97%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84)
    - [パスの名前を指定する。](#%E3%83%91%E3%82%B9%E3%81%AE%E5%90%8D%E5%89%8D%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B)
    - [paramsの機能](#params%E3%81%AE%E6%A9%9F%E8%83%BD)
    - [リクエストを送ってきたユーザーの情報を取得するには？](#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E9%80%81%E3%81%A3%E3%81%A6%E3%81%8D%E3%81%9F%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF)
    - [redirect_toメソッドの仕組み](#redirect_to%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF)
    - [フラッシュの仕組み](#%E3%83%95%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF)
    - [呼び出すテンプレートを指定したいときは？](#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF)
    - [HTMLなどのタグをタグとして出力したいとき](#html%E3%81%AA%E3%81%A9%E3%81%AE%E3%82%BF%E3%82%B0%E3%82%92%E3%82%BF%E3%82%B0%E3%81%A8%E3%81%97%E3%81%A6%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D)
    - [小数点以下の桁数など文字列や数字の書式を揃えたいときは？](#%E5%B0%8F%E6%95%B0%E7%82%B9%E4%BB%A5%E4%B8%8B%E3%81%AE%08%E6%A1%81%E6%95%B0%E3%81%AA%E3%81%A9%E6%96%87%E5%AD%97%E5%88%97%E3%82%84%E6%95%B0%E5%AD%97%E3%81%AE%E6%9B%B8%E5%BC%8F%E3%82%92%E6%8F%83%E3%81%88%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF)
    - [日付オブジェクトや日時オブジェクトを文字列に変換するメソッドは？](#%E6%97%A5%E4%BB%98%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%84%E6%97%A5%E6%99%82%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E6%96%87%E5%AD%97%E5%88%97%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF)
    - [３桁ごとにカンマを入れて数値を表示させたいときは？](#%EF%BC%93%E6%A1%81%E3%81%94%E3%81%A8%E3%81%AB%E3%82%AB%E3%83%B3%E3%83%9E%E3%82%92%E5%85%A5%E3%82%8C%E3%81%A6%E6%95%B0%E5%80%A4%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%95%E3%81%9B%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF)
    - [HTML特殊文字を変換したいときは？](#html%E7%89%B9%E6%AE%8A%E6%96%87%E5%AD%97%E3%82%92%E5%A4%89%E6%8F%9B%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF)
    - [指定のパスが現在のベージだったらリンクにしないようにするには？](#%E6%8C%87%E5%AE%9A%E3%81%AE%E3%83%91%E3%82%B9%E3%81%8C%E7%8F%BE%E5%9C%A8%E3%81%AE%E3%83%99%E3%83%BC%E3%82%B8%E3%81%A0%E3%81%A3%E3%81%9F%E3%82%89%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AB%E3%81%97%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF)
    - [画像にリンクを貼りたいときは？](#%E7%94%BB%E5%83%8F%E3%81%AB%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E8%B2%BC%E3%82%8A%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF)
    - [Rubyのメソッドを使ってタグを出力するには？](#ruby%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%BF%E3%82%B0%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF)
    - [レイアウトテンプレートのレンダリングの順番](#%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E9%A0%86%E7%95%AA)
    - [レイアウトテンプレートの切り替え方法](#%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E6%96%B9%E6%B3%95)
    - [タイムゾーンの設定](#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%BE%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A)
    - [マイグレーションファイルあれこれ](#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%82%E3%82%8C%E3%81%93%E3%82%8C)
    - [シードデータ](#%E3%82%B7%E3%83%BC%E3%83%89%E3%83%87%E3%83%BC%E3%82%BF)
    - [SQLとは違いクエリメソッドは繋げる順番は自由](#sql%E3%81%A8%E3%81%AF%E9%81%95%E3%81%84%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AF%1C%E7%B9%8B%E3%81%92%E3%82%8B%E9%A0%86%E7%95%AA%E3%81%AF%E8%87%AA%E7%94%B1)
    - [ファインダーメソッド](#%08%E3%83%95%E3%82%A1%E3%82%A4%E3%83%B3%E3%83%80%E3%83%BC%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [Railsにおけるリソース](#rails%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9)
    - [7つのアクション以外の任意のアクションを追加したいとき](#7%E3%81%A4%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E4%BB%A5%E5%A4%96%E3%81%AE%E4%BB%BB%E6%84%8F%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D)
    - [オブジェクトでパスを表す](#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A7%E3%83%91%E3%82%B9%E3%82%92%E8%A1%A8%E3%81%99)
    - [form_tagメソッド](#form_tag%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [text_field_tagメソッド](#text_field_tag%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [&.演算子](#%E6%BC%94%E7%AE%97%E5%AD%90)
    - [form.checkbox](#form%08checkbox)
    - [form.radio_button](#formradio_button)
    - [form.select](#formselect)
    - [form.date_select](#formdate_select)
    - [モデルのエラーオブジェクトを確認する](#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B)
    - [validation例](#validation%E4%BE%8B)
    - [Emailのvalidationの際に便利なGem](#email%E3%81%AEvalidation%E3%81%AE%E9%9A%9B%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%AAgem)
    - [エラーメッセージのCSSを変更するには](#%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%81%AEcss%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF)
    - [アプリケーションの日本語化](#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%8C%96)
    - [エラーメッセージを日本語化する](#%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%92%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%8C%96%E3%81%99%E3%82%8B)
    - [単数リソースを扱う時のルーティング](#%08%E5%8D%98%E6%95%B0%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%92%E6%89%B1%E3%81%86%E6%99%82%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0)
    - [Railsでセッションデータにアクセスする](#rails%E3%81%A7%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B)
    - [Railsでパスワード保存の手順](#rails%E3%81%A7%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E4%BF%9D%E5%AD%98%E3%81%AE%E6%89%8B%E9%A0%86)
    - [helper_method](#helper_method)
    - [form_forのオプション](#form_for%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3)
    - [controllerメソッド](#controller%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [パスワード変更フォームを作成するときのvalidation](#%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E5%A4%89%E6%9B%B4%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AEvalidation)
    - [new_recordメソッド](#new_record%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [advanceメソッドで日時を進める](#advance%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A7%E6%97%A5%E6%99%82%E3%82%92%E9%80%B2%E3%82%81%E3%82%8B)
    - [スコープ](#%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97)
    - [truncateメソッド](#truncate%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [バリデーションエラーを自分で設定する](#%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%92%E8%87%AA%E5%88%86%E3%81%A7%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B)
    - [ページネーションの設定方法](#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95)
    - [foreign_keyオプションを利用して、外部キーの名前を任意のものにする](#foreign_key%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E3%81%AE%E5%90%8D%E5%89%8D%E3%82%92%E4%BB%BB%E6%84%8F%E3%81%AE%E3%82%82%E3%81%AE%E3%81%AB%E3%81%99%E3%82%8B)
    - [class_nameオプションを利用して、関連付けで使われるメソッド名を変更する](#class_name%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E9%96%A2%E9%80%A3%E4%BB%98%E3%81%91%E3%81%A7%E4%BD%BF%E3%82%8F%E3%82%8C%E3%82%8B%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%90%8D%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B)
    - [dependentオプションを利用して、参照先のレコードを削除した時に参照元のレコードも自動的に削除するようにする](#dependent%08%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E5%8F%82%E7%85%A7%E5%85%88%E3%81%AE%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E5%8F%82%E7%85%A7%E5%85%83%E3%81%AE%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%82%82%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AB%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B)
    - [MySQLやPostgreSQLで外部キー制約を設定するにはforeign_keyオプションを利用する](#mysql%E3%82%84%08postgresql%E3%81%A7%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E5%88%B6%E7%B4%84%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AFforeign_key%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B)
    - [link_to_ifメソッド](#link_to_if%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [rescue_fromメソッドを利用して、エラー表示をカスタマイズする](#rescue_from%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%82%A8%E3%83%A9%E3%83%BC%E8%A1%A8%E7%A4%BA%E3%82%92%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B)
    - [資格情報を編集する](#%E8%B3%87%E6%A0%BC%E6%83%85%E5%A0%B1%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B)
    - [本番モード設定](#%E6%9C%AC%E7%95%AA%E3%83%A2%E3%83%BC%E3%83%89%E8%A8%AD%E5%AE%9A)
    - [turbolinks](#turbolinks)
    - [Active Storageの利用法](#active-storage%E3%81%AE%E5%88%A9%E7%94%A8%E6%B3%95)
    - [ファイルアップロード時のバリデーション](#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E6%99%82%E3%81%AE%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)
    - [添付ファイルの削除](#%E6%B7%BB%E4%BB%98%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%89%8A%E9%99%A4)
    - [link_to_unlessメソッド](#link_to_unless%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [sourceメソッドを利用して、関連付けの名前に対象となるモデルの名前以外のものを使う](#source%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E9%96%A2%E9%80%A3%E4%BB%98%E3%81%91%E3%81%AE%E5%90%8D%E5%89%8D%E3%81%AB%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%AA%E3%82%8B%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E5%90%8D%E5%89%8D%E4%BB%A5%E5%A4%96%E3%81%AE%E3%82%82%E3%81%AE%E3%82%92%E4%BD%BF%E3%81%86)
    - [namespaceメソッドを利用して、名前空間を導入する](#namespace%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E5%90%8D%E5%89%8D%E7%A9%BA%E9%96%93%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%99%E3%82%8B)
  - [現場で使える Ruby on Rails 5速習実践ガイド](#%E7%8F%BE%E5%A0%B4%E3%81%A7%E4%BD%BF%E3%81%88%E3%82%8B-ruby-on-rails-5%E9%80%9F%E7%BF%92%E5%AE%9F%E8%B7%B5%E3%82%AC%E3%82%A4%E3%83%89)
    - [slimを使えるようにするには](#slim%E3%82%92%E4%BD%BF%E3%81%88%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF)
    - [hメソッド](#h%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [simple_format(text, {}, sanitize, wrapper_tag)](#simple_formattext--sanitize-wrapper_tag)
    - [change_column_nullメソッドを利用して、後からNOT NULL制約をつける](#change_column_null%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E5%BE%8C%E3%81%8B%E3%82%89not-null%E5%88%B6%E7%B4%84%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B)
    - [change_columnの場合は自動的にマイグレーションを戻すことができない](#change_column%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF%E8%87%AA%E5%8B%95%E7%9A%84%E3%81%AB%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E6%88%BB%E3%81%99%E3%81%93%E3%81%A8%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84)
    - [セッションとは](#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%81%AF)
    - [Cookieとは](#cookie%E3%81%A8%E3%81%AF)
    - [RSpecの準備](#rspec%E3%81%AE%E6%BA%96%E5%82%99)
    - [Capybaraの準備](#capybara%E3%81%AE%E6%BA%96%E5%82%99)
    - [FactoryBotのインストール](#factorybot%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB)
    - [国際化](#%E5%9B%BD%E9%9A%9B%E5%8C%96)
      - [ユーザーごとに言語を切り替える](#%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%94%E3%81%A8%E3%81%AB%E8%A8%80%E8%AA%9E%E3%82%92%E5%88%87%E3%82%8A%E6%9B%BF%E3%81%88%E3%82%8B)
    - [翻訳ファイルの扱い方](#%E7%BF%BB%E8%A8%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%89%B1%E3%81%84%E6%96%B9)
    - [日時の扱い方に関する設定](#%E6%97%A5%E6%99%82%E3%81%AE%E6%89%B1%E3%81%84%E6%96%B9%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E8%A8%AD%E5%AE%9A)
    - [アプリケーションのデフォルトのタイムゾーンを日本時間にする](#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%BE%E3%83%BC%E3%83%B3%E3%82%92%E6%97%A5%E6%9C%AC%E6%99%82%E9%96%93%E3%81%AB%E3%81%99%E3%82%8B)
    - [コンソールをsandboxモードで起動する](#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%92sandbox%E3%83%A2%E3%83%BC%E3%83%89%E3%81%A7%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B)
    - [開発環境で本番用のエラー画面を出して動作確認したい場合](#%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83%E3%81%A7%E6%9C%AC%E7%95%AA%E7%94%A8%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E7%94%BB%E9%9D%A2%E3%82%92%E5%87%BA%E3%81%97%E3%81%A6%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88)
    - [ログを出力するには](#%E3%83%AD%E3%82%B0%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF)
    - [ログレベルの変更](#%E3%83%AD%E3%82%B0%E3%83%AC%E3%83%99%E3%83%AB%E3%81%AE%E5%A4%89%E6%9B%B4)
    - [ログに特定のパラメーターの値を表示しないようにする](#%E3%83%AD%E3%82%B0%E3%81%AB%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E5%80%A4%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%97%E3%81%AA%E3%81%84%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B)
    - [Rails.csrfToken()関数](#railscsrftoken%E9%96%A2%E6%95%B0)
    - [sanitizeメソッド](#sanitize%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [Rubyコードインジェクション](#ruby%E3%82%B3%E3%83%BC%E3%83%89%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3)
    - [CSP](#csp)
    - [Production環境でアプリケーションを立ち上げる](#production%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E3%82%8B)
    - [`credentials.yml.enc`に記述された秘密情報を確認する](#credentialsymlenc%E3%81%AB%E8%A8%98%E8%BF%B0%E3%81%95%E3%82%8C%E3%81%9F%E7%A7%98%E5%AF%86%E6%83%85%E5%A0%B1%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B)
    - [`credentials.yml.enc`に記述された秘密情報を編集する](#credentialsymlenc%E3%81%AB%E8%A8%98%E8%BF%B0%E3%81%95%E3%82%8C%E3%81%9F%E7%A7%98%E5%AF%86%E6%83%85%E5%A0%B1%E3%82%92%E7%B7%A8%E9%9B%86%E3%81%99%E3%82%8B)
    - [アプリケーションからcredentialsを参照する](#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8B%E3%82%89credentials%E3%82%92%E5%8F%82%E7%85%A7%E3%81%99%E3%82%8B)
    - [ransackを使って検索機能を実装する](#ransack%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%A4%9C%E7%B4%A2%E6%A9%9F%E8%83%BD%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B)
      - [controller側](#controller%E5%81%B4)
      - [model側](#model%E5%81%B4)
      - [view側](#view%E5%81%B4)
    - [メイラー](#%E3%83%A1%E3%82%A4%E3%83%A9%E3%83%BC)
      - [メイラーの実装](#%E3%83%A1%E3%82%A4%E3%83%A9%E3%83%BC%E3%81%AE%E5%AE%9F%E8%A3%85)
      - [テンプレートの実装](#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E5%AE%9F%E8%A3%85)
      - [メール送信処理](#%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%81%E4%BF%A1%E5%87%A6%E7%90%86)
      - [メイラーのテスト](#%E3%83%A1%E3%82%A4%E3%83%A9%E3%83%BC%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88)
    - [ファイルアップロード](#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89)
      - [ActiveStorageの準備](#activestorage%E3%81%AE%E6%BA%96%E5%82%99)
      - [モデルに画像を添付する](#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E7%94%BB%E5%83%8F%E3%82%92%E6%B7%BB%E4%BB%98%E3%81%99%E3%82%8B)
      - [ビュー側](#%E3%83%93%E3%83%A5%E3%83%BC%E5%81%B4)
      - [ActiveStorage::Blob](#activestorageblob)
      - [ActiveStorage::Attachment](#activestorageattachment)
    - [CSV入出力](#csv%E5%85%A5%E5%87%BA%E5%8A%9B)
      - [導入](#%E5%B0%8E%E5%85%A5)
      - [Export](#export)
          - [モデル側](#%E3%83%A2%E3%83%87%E3%83%AB%E5%81%B4)
          - [コントローラ側](#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E5%81%B4)
          - [テンプレート側](#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E5%81%B4)
      - [IMPORT](#import)
          - [モデル側](#%E3%83%A2%E3%83%87%E3%83%AB%E5%81%B4-1)
          - [コントローラ側](#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E5%81%B4-1)
          - [ビュー側](#%E3%83%93%E3%83%A5%E3%83%BC%E5%81%B4-1)
          - [ルーティング](#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0)
    - [ページネーション](#%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%8D%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)
      - [導入](#%E5%B0%8E%E5%85%A5-1)
      - [コントローラ側](#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E5%81%B4-2)
      - [ビュー側](#%E3%83%93%E3%83%A5%E3%83%BC%E5%81%B4-2)
      - [kaminariはデフォルトの翻訳ファイルはenなのでロケールをjaに直す必要がある](#kaminari%E3%81%AF%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E7%BF%BB%E8%A8%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AFen%E3%81%AA%E3%81%AE%E3%81%A7%E3%83%AD%E3%82%B1%E3%83%BC%E3%83%AB%E3%82%92ja%E3%81%AB%E7%9B%B4%E3%81%99%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B)
      - [動作確認](#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D)
      - [デザインの調整](#%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E8%AA%BF%E6%95%B4)
      - [表示件数を変更したいとき](#%E8%A1%A8%E7%A4%BA%E4%BB%B6%E6%95%B0%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%97%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D)
    - [ActiveJob（Sidekiqを使用）](#activejobsidekiq%E3%82%92%E4%BD%BF%E7%94%A8)
      - [導入](#%E5%B0%8E%E5%85%A5-2)
      - [ジョブの作成、実行](#%E3%82%B8%E3%83%A7%E3%83%96%E3%81%AE%E4%BD%9C%E6%88%90%E5%AE%9F%E8%A1%8C)
    - [AjaxでRailsサーバと通信する](#ajax%E3%81%A7rails%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E9%80%9A%E4%BF%A1%E3%81%99%E3%82%8B)
      - [削除時にページ遷移ではなくAjaxリクエストを発生させる](#%E5%89%8A%E9%99%A4%E6%99%82%E3%81%AB%E3%83%9A%E3%83%BC%E3%82%B8%E9%81%B7%E7%A7%BB%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fajax%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%82%8B)
      - [削除したタスクを非表示にする(ajax:successイベントに応じてタスクを削除する方法)](#%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E9%9D%9E%E8%A1%A8%E7%A4%BA%E3%81%AB%E3%81%99%E3%82%8Bajaxsuccess%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AB%E5%BF%9C%E3%81%98%E3%81%A6%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95)
      - [削除したタスクを非表示にする(javascriptのレスポンスを実行してタスクを削除する方法)](#%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E9%9D%9E%E8%A1%A8%E7%A4%BA%E3%81%AB%E3%81%99%E3%82%8Bjavascript%E3%81%AE%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95)
    - [Turbolinks](#turbolinks)
      - [ブラウザのページ遷移が発生しないことが多くなる問題](#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%AE%E3%83%9A%E3%83%BC%E3%82%B8%E9%81%B7%E7%A7%BB%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%97%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E5%A4%9A%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C)
      - [<scrip>はhead要素内に記述すること](#scrip%E3%81%AFhead%E8%A6%81%E7%B4%A0%E5%86%85%E3%81%AB%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8)
      - [turbolinksを無効にする](#turbolinks%E3%82%92%E7%84%A1%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B)
    - [Webpacker](#webpacker)
      - [導入](#%E5%B0%8E%E5%85%A5-3)
      - [コンパイルの実行](#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%AE%E5%AE%9F%E8%A1%8C)
      - [Reactを導入してみる](#react%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B)
    - [チーム開発時気をつけるべきこと](#%E3%83%81%E3%83%BC%E3%83%A0%E9%96%8B%E7%99%BA%E6%99%82%E6%B0%97%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%93%E3%81%A8)
      - [PullRequest時に気をつけること](#pullrequest%E6%99%82%E3%81%AB%E6%B0%97%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%93%E3%81%A8)
    - [find_or_create_by!メソッド](#find_or_create_by%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [バージョンアップ](#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97)
      - [bundle updateをこまめにする](#bundle-update%E3%82%92%E3%81%93%E3%81%BE%E3%82%81%E3%81%AB%E3%81%99%E3%82%8B)
          - [バージョンが上がったgemを確認する](#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%8C%E4%B8%8A%E3%81%8C%E3%81%A3%E3%81%9Fgem%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B)
          - [バージョンアップ内容が妥当か調査する](#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E5%86%85%E5%AE%B9%E3%81%8C%E5%A6%A5%E5%BD%93%E3%81%8B%E8%AA%BF%E6%9F%BB%E3%81%99%E3%82%8B)
          - [バージョンアップの内容に問題があった場合はgemのバージョンを戻す](#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%E3%81%AE%E5%86%85%E5%AE%B9%E3%81%AB%E5%95%8F%E9%A1%8C%E3%81%8C%E3%81%82%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AFgem%E3%81%AE%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%82%92%E6%88%BB%E3%81%99)
      - [マイグレーションファイルはロールバックできるかを確認すること](#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AF%E3%83%AD%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8)
    - [マイグレーションファイルを一つにまとめるgem「Squasher」](#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%B8%80%E3%81%A4%E3%81%AB%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8Bgemsquasher)
    - [マイグレーションフィルの注意点](#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A3%E3%83%AB%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9)
      - [マイグレーションファイルが成長し変化するコード（マイグレーションファイルの外側にあるコード）に依存するのは危険](#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E6%88%90%E9%95%B7%E3%81%97%E5%A4%89%E5%8C%96%E3%81%99%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%A4%96%E5%81%B4%E3%81%AB%E3%81%82%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AB%E4%BE%9D%E5%AD%98%E3%81%99%E3%82%8B%E3%81%AE%E3%81%AF%E5%8D%B1%E9%99%BA)
      - [一度にインスタンス化するレコード数に気をつける](#%E4%B8%80%E5%BA%A6%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E5%8C%96%E3%81%99%E3%82%8B%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E6%95%B0%E3%81%AB%E6%B0%97%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B)
      - [失敗時には例外を発生させる](#%E5%A4%B1%E6%95%97%E6%99%82%E3%81%AB%E3%81%AF%E4%BE%8B%E5%A4%96%E3%82%92%E7%99%BA%E7%94%9F%E3%81%95%E3%81%9B%E3%82%8B)
      - [スキーマキャッシュの存在を意識する](#%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%AD%98%E5%9C%A8%E3%82%92%E6%84%8F%E8%AD%98%E3%81%99%E3%82%8B)
    - [一度に多くのレコードを操作するときはfind_eachメソッド](#%E4%B8%80%E5%BA%A6%E3%81%AB%E5%A4%9A%E3%81%8F%E3%81%AE%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AFfind_each%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [`bundle install`と`bundle updateの違い`](#bundle-install%E3%81%A8bundle-update%E3%81%AE%E9%81%95%E3%81%84)
    - [リファクタリング](#%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0)
      - [第一の鍵-適切な場所にコードを書く](#%E7%AC%AC%E4%B8%80%E3%81%AE%E9%8D%B5-%E9%81%A9%E5%88%87%E3%81%AA%E5%A0%B4%E6%89%80%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F)
          - [モデルに書くべきコードをモデルに寄せる](#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E6%9B%B8%E3%81%8F%E3%81%B9%E3%81%8D%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E5%AF%84%E3%81%9B%E3%82%8B)
      - [第二の鍵 - 上手に共通化する](#%E7%AC%AC%E4%BA%8C%E3%81%AE%E9%8D%B5---%E4%B8%8A%E6%89%8B%E3%81%AB%E5%85%B1%E9%80%9A%E5%8C%96%E3%81%99%E3%82%8B)
          - [モデルの共通化](#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E5%85%B1%E9%80%9A%E5%8C%96)
    - [共通機能のモジュールを複数のモデルクラスにMix-inする](#%E5%85%B1%E9%80%9A%E6%A9%9F%E8%83%BD%E3%81%AE%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%A2%E3%83%87%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%ABmix-in%E3%81%99%E3%82%8B)
    - [STI(単一テーブル継承)で共通機能を持たせる](#sti%E5%8D%98%E4%B8%80%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E7%B6%99%E6%89%BF%E3%81%A7%E5%85%B1%E9%80%9A%E6%A9%9F%E8%83%BD%E3%82%92%E6%8C%81%E3%81%9F%E3%81%9B%E3%82%8B)
    - [全モデルクラスに共通の処理をApplicationRecordに書く](#%E5%85%A8%E3%83%A2%E3%83%87%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%85%B1%E9%80%9A%E3%81%AE%E5%87%A6%E7%90%86%E3%82%92applicationrecord%E3%81%AB%E6%9B%B8%E3%81%8F)
      - [AppliationRecordとモデルクラスの間に抽象的なクラスを挟む](#appliationrecord%E3%81%A8%E3%83%A2%E3%83%87%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E9%96%93%E3%81%AB%E6%8A%BD%E8%B1%A1%E7%9A%84%E3%81%AA%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%8C%9F%E3%82%80)
    - [共通機能のモジュールを複数のコントローラクラスにMix-inする](#%E5%85%B1%E9%80%9A%E6%A9%9F%E8%83%BD%E3%81%AE%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E8%A4%87%E6%95%B0%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%ABmix-in%E3%81%99%E3%82%8B)
    - [基底クラスを追加して共通機能を持たせる](#%E5%9F%BA%E5%BA%95%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%A6%E5%85%B1%E9%80%9A%E6%A9%9F%E8%83%BD%E3%82%92%E6%8C%81%E3%81%9F%E3%81%9B%E3%82%8B)
    - [コントローラを共通化する前にモデルに切り出せないか考える](#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%82%92%E5%85%B1%E9%80%9A%E5%8C%96%E3%81%99%E3%82%8B%E5%89%8D%E3%81%AB%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AB%E5%88%87%E3%82%8A%E5%87%BA%E3%81%9B%E3%81%AA%E3%81%84%E3%81%8B%E8%80%83%E3%81%88%E3%82%8B)
    - [パーシャルを作る際はHTML構造の類似性だけでなく、目的の類似性に着目する](#%E3%83%91%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%92%E4%BD%9C%E3%82%8B%E9%9A%9B%E3%81%AFhtml%E6%A7%8B%E9%80%A0%E3%81%AE%E9%A1%9E%E4%BC%BC%E6%80%A7%E3%81%A0%E3%81%91%E3%81%A7%E3%81%AA%E3%81%8F%E7%9B%AE%E7%9A%84%E3%81%AE%E9%A1%9E%E4%BC%BC%E6%80%A7%E3%81%AB%E7%9D%80%E7%9B%AE%E3%81%99%E3%82%8B)
    - [書き方に注意する](#%E6%9B%B8%E3%81%8D%E6%96%B9%E3%81%AB%E6%B3%A8%E6%84%8F%E3%81%99%E3%82%8B)
    - [アクションごとにレイアウトを変更したい場合](#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%94%E3%81%A8%E3%81%AB%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88)
    - [共通処理を担当するオブジェクトを別に作って連携させる](#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%E3%82%92%E6%8B%85%E5%BD%93%E3%81%99%E3%82%8B%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E5%88%A5%E3%81%AB%E4%BD%9C%E3%81%A3%E3%81%A6%E9%80%A3%E6%90%BA%E3%81%95%E3%81%9B%E3%82%8B)
      - [意味のあるパラメーターの集合からクラスを生み出す](#%E6%84%8F%E5%91%B3%E3%81%AE%E3%81%82%E3%82%8B%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E9%9B%86%E5%90%88%E3%81%8B%E3%82%89%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E7%94%9F%E3%81%BF%E5%87%BA%E3%81%99)
      - [外部サービスのロジックを閉じ込める](#%E5%A4%96%E9%83%A8%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E3%83%AD%E3%82%B8%E3%83%83%E3%82%AF%E3%82%92%E9%96%89%E3%81%98%E8%BE%BC%E3%82%81%E3%82%8B)
      - [複数のモデルが絡む特定処理の専門家を作る](#%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%A2%E3%83%87%E3%83%AB%E3%81%8C%E7%B5%A1%E3%82%80%E7%89%B9%E5%AE%9A%E5%87%A6%E7%90%86%E3%81%AE%E5%B0%82%E9%96%80%E5%AE%B6%E3%82%92%E4%BD%9C%E3%82%8B)
      - [サブリソース単位でコントローラーを分割する](#%E3%82%B5%E3%83%96%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E5%8D%98%E4%BD%8D%E3%81%A7%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E3%82%92%E5%88%86%E5%89%B2%E3%81%99%E3%82%8B)
  - [パーフェクトRuby on Rails](#%E3%83%91%E3%83%BC%E3%83%95%E3%82%A7%E3%82%AF%E3%83%88ruby-on-rails)
    - [「!」付きメソッドとバリデーション](#%E4%BB%98%E3%81%8D%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)
    - [gsubでブロックを使った置換](#gsub%E3%81%A7%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E7%BD%AE%E6%8F%9B)
    - [コールバックを起動する条件の設定](#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B%E6%9D%A1%E4%BB%B6%E3%81%AE%E8%A8%AD%E5%AE%9A)
    - [enum](#enum)
    - [コールバックのスキップ](#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%AE%E3%82%B9%E3%82%AD%E3%83%83%E3%83%97)
    - [rescue_from](#rescue_from)
    - [variants](#variants)
    - [rawメソッド](#raw%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [JSONの構築](#json%E3%81%AE%E6%A7%8B%E7%AF%89)
    - [Sprocketsの作り方](#sprockets%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9)
    - [新しく作成したディレクトリを、アセットパスに追加したい](#%E6%96%B0%E3%81%97%E3%81%8F%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%83%91%E3%82%B9%E3%81%AB%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%81%84)
    - [プリコンパイル対象を新しく追加したい](#%E3%83%97%E3%83%AA%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E5%AF%BE%E8%B1%A1%E3%82%92%E6%96%B0%E3%81%97%E3%81%8F%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%81%84)
    - [jquery-turbolinks?](#jquery-turbolinks)
    - [あるディレクトリをオートロードする](#%E3%81%82%E3%82%8B%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92%E3%82%AA%E3%83%BC%E3%83%88%E3%83%AD%E3%83%BC%E3%83%89%E3%81%99%E3%82%8B)
    - [モデルとビューを橋渡しするactive_decorator](#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%A8%E3%83%93%E3%83%A5%E3%83%BC%E3%82%92%E6%A9%8B%E6%B8%A1%E3%81%97%E3%81%99%E3%82%8Bactive_decorator)
    - [sidekiq](#sidekiq)
    - [Better Errorsでエラー画面をリッチにする](#better-errors%E3%81%A7%E3%82%A8%E3%83%A9%E3%83%BC%E7%94%BB%E9%9D%A2%E3%82%92%E3%83%AA%E3%83%83%E3%83%81%E3%81%AB%E3%81%99%E3%82%8B)
    - [springサーバによる不具合の場合](#spring%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E3%82%88%E3%82%8B%E4%B8%8D%E5%85%B7%E5%90%88%E3%81%AE%E5%A0%B4%E5%90%88)
    - [rails-erdでモデルのER図を生成する](#rails-erd%E3%81%A7%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AEer%E5%9B%B3%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B)
  - [その他](#%E3%81%9D%E3%81%AE%E4%BB%96)
    - [環境構築の手順(2018/11/04)](#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%81%AE%E6%89%8B%E9%A0%8620181104)
    - [Facebookログイン実装手順](#facebook%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E5%AE%9F%E8%A3%85%E6%89%8B%E9%A0%86)
    - [CarrierWave(gem)使用手順](#carrierwavegem%E4%BD%BF%E7%94%A8%E6%89%8B%E9%A0%86)
    - [gem geocoder を使うときに住所を日本語対応にする方法](#gem-geocoder-%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E3%81%8D%E3%81%AB%E4%BD%8F%E6%89%80%E3%82%92%E6%97%A5%E6%9C%AC%E8%AA%9E%E5%AF%BE%E5%BF%9C%E3%81%AB%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95)
    - [request.refererとは](#requestreferer%E3%81%A8%E3%81%AF)
    - [renderの部分テンプレートの呼び出しの際の注意点](#render%E3%81%AE%E9%83%A8%E5%88%86%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E9%9A%9B%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9)
    - [groupに関連するエラーメッセージを表示したい。](#group%E3%81%AB%E9%96%A2%E9%80%A3%E3%81%99%E3%82%8B%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%97%E3%81%9F%E3%81%84)
    - [toastr表示法](#toastr%E8%A1%A8%E7%A4%BA%E6%B3%95)
      - [application.jsでrequireする時jqueryよりも下に配置しなければならない](#applicationjs%E3%81%A7require%E3%81%99%E3%82%8B%E6%99%82jquery%E3%82%88%E3%82%8A%E3%82%82%E4%B8%8B%E3%81%AB%E9%85%8D%E7%BD%AE%E3%81%97%E3%81%AA%E3%81%91%E3%82%8C%E3%81%B0%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84)
      - [toastrの最新版は記述内容が旧版と異なる](#toastr%E3%81%AE%E6%9C%80%E6%96%B0%E7%89%88%E3%81%AF%E8%A8%98%E8%BF%B0%E5%86%85%E5%AE%B9%E3%81%8C%E6%97%A7%E7%89%88%E3%81%A8%E7%95%B0%E3%81%AA%E3%82%8B)
    - [テーブル作成の際、references型で外部キーを指定した時のメリット](#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E4%BD%9C%E6%88%90%E3%81%AE%E9%9A%9Breferences%E5%9E%8B%E3%81%A7%E5%A4%96%E9%83%A8%E3%82%AD%E3%83%BC%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E6%99%82%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88)
    - [リファクタリング](#%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0-1)
      - [同じ処理を繰り返し書く場合](#%E5%90%8C%E3%81%98%E5%87%A6%E7%90%86%E3%82%92%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97%E6%9B%B8%E3%81%8F%E5%A0%B4%E5%90%88)
      - [複雑な条件分岐がある場合](#%E8%A4%87%E9%9B%91%E3%81%AA%E6%9D%A1%E4%BB%B6%E5%88%86%E5%B2%90%E3%81%8C%E3%81%82%E3%82%8B%E5%A0%B4%E5%90%88)
      - [複数のコントローラーに同じ処理が記述されている場合](#%E8%A4%87%E6%95%B0%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC%E3%81%AB%E5%90%8C%E3%81%98%E5%87%A6%E7%90%86%E3%81%8C%E8%A8%98%E8%BF%B0%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88)
      - [コントローラに複雑な処理を記述している場合](#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AB%E8%A4%87%E9%9B%91%E3%81%AA%E5%87%A6%E7%90%86%E3%82%92%E8%A8%98%E8%BF%B0%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88)
    - [マイグレーションファイルをバージョン指定して削除する。](#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%A6%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B)
    - [テーブルを削除する](#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B)
    - [カラムを削除する](#%E3%82%AB%E3%83%A9%E3%83%A0%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B)
    - [モデルやルートを簡単に確認する](#%E3%83%A2%E3%83%87%E3%83%AB%E3%82%84%E3%83%AB%E3%83%BC%E3%83%88%E3%82%92%E7%B0%A1%E5%8D%98%E3%81%AB%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B)
    - [fetchメソッド](#fetch%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89)
    - [ヘッダー情報を取得](#%E3%83%98%E3%83%83%E3%83%80%E3%83%BC%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97)
    - [ヘルパーメソッドを自作するときはhメソッドが便利](#%E3%83%98%E3%83%AB%E3%83%91%E3%83%BC%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E8%87%AA%E4%BD%9C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AFh%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8C%E4%BE%BF%E5%88%A9)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# Rails学習まとめ
- [改訂4版 基礎Ruby on Rails](https://book.impress.co.jp/books/1117101135)
- [現場で使える Ruby on Rails 5速習実践ガイド](https://www.amazon.co.jp/dp/B07JHQ9B5T/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)
- [パーフェクトRuby on Rails](https://www.amazon.co.jp/%E3%83%91%E3%83%BC%E3%83%95%E3%82%A7%E3%82%AF%E3%83%88Ruby-Rails-%E3%81%99%E3%81%8C%E3%82%8F%E3%82%89%E3%81%BE%E3%81%95%E3%81%AE%E3%82%8A-ebook/dp/B00P0UR1RU/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&keywords=%E3%83%91%E3%83%BC%E3%83%95%E3%82%A7%E3%82%AF%E3%83%88rails&qid=1555740150&s=digital-text&sr=1-1-catcorr)

## 改訂4版 基礎Ruby on Rails

### 例外処理

```rb
begin
  例外が発生しうるプログラム
rescue
  例外の発生後に実行するプログラム
else
  例外が発生しなかった場合のプログラム
end
```

### allメソッド
- 全ての要素が条件を満たすかを調べる

### anyメソッド
- どれか一つが条件を満たすかを調べる

### detectメソッド
- ある条件を満たす要素を一つ取り出す

### find_allメソッド
- 条件を満たす要素を全て取り出す

### メソッドの引数にハッシュを取るとき
- ハッシュを引数にするとブレイスを省略できる

`foo({ height: 30, weight: 40 })`
`foo( height: 30, weight: 40 )`
`foo height: 30, weight: 40`

### ActiveSupport::TimeWithZoneクラスのインスタンス

```rb
t = Time.current
puts t.month # 月を表示
puts t.wday # 週を表示
puts t.hour # 時を表示
puts t.min # 分を表示

# 今から1ヶ月後の24時間後
Time.current.next_month.tomorrow

# 明日の午前0時
Time.current.tomorrow.beginning_of_day

# advenceメソッドに「days: 日数」を指定すると、その日数だけ日時を進める。「hours: 3」(3時間後)、「days: -2」(2日前)
Time.current.advance(days: 3).beginning_of_day
```

### クラスメソッドの中のself
- クラスメソッドの中のselfはクラス自信を指す

```rb
class User
  def self.foo
    new #=> User.newと同じ意味
  end
end
```

### リダイレクション
- レスポンスのステータスコードを3系にする

### findメソッドは引数を自動的に整数型に変換する

```rb
 def show
    @user = User.find(params[:id])
    # params[:id]は文字列型の "1" ですが、findメソッドでは自動的に整数型に変換されます
  end
```

### MD5のハッシュ化

MD5ハッシュでは大文字と小文字を区別する。
RubyではDigestライブラリのhexdigestメソッドを使うとMD5のハッシュ化ができる。

```rb
def gravatar_for(user)
    gravatar_id = Digest::MD5::hexdigest(user.email.downcase)
    # MD5ハッシュでは大文字と小文字が区別されるので、Rubyのdowncaseメソッドを使って
    # hexdigestの引数を小文字に変換しています。
    gravatar_url = "https://secure.gravatar.com/avatar/#{gravatar_id}"
    image_tag(gravatar_url, alt: user.name, class: "gravatar")
  end
```
### アクションでないメソッドをコントローラーに記述する場合はプライベートメソッドにしなければならない

### パスの名前を指定する。

```rb
get "about" => "top#about", as: "about"
  # /about
  # about_path
  # link_toメソッドやredirect_toメソッドではシンボルでパスを指定できる。
  # 例：　link_to "このサイトについて", :about
```

### paramsの機能

paramsはActionController::Parametersクラスのオブジェクトなので、文字列でもシンボルでも値を取り出せる。

```rb
○ params[:name]
○ params["name"]
```
また、paramsが返すパラメータにはコントローラ名とアクション名も含んでいるため、以下のようにできる。

```rb
class LessonController < ApplicationController
  def step2
    render plain: params[:controller] + "#" + params[:action]
  end
end

#=> lesson#step2
```

### リクエストを送ってきたユーザーの情報を取得するには？
requestメソッドを使う。

```rb
# IPアドレスを取得したい時
request.remote_ip

# 環境変数を取得したい時
request.env

# リクエストヘッダーを取得したい時
request.headers

# 例：ブラウザの種類を取得する場合。
request.env["HTTP_USER_AGENT"]
request.headers["User-Agent"]
```

### redirect_toメソッドの仕組み
redirect_toメソッドを呼び出すと、レンダリングは行われずにブラウザにステータスコード302とURLが送られる。

レンダリングとはサーバーから送られたデータをブラウザが整形すること。（Webページが表示される時HTMLのコードの状態ではなく、コードを解読し整えられたページが表示される。）

- ステータスコード
 - 301（恒久的な移動）
 - 302(発見)
 - 303(他を参照)
 - 307(一時的な移動)

### フラッシュの仕組み
リダイレクションの前でflashオブジェクトに情報を入れておくと、リダイレクション後のアクションでその文字列を取り出すことができる。

フラッシュのデータは「アクション→リダイレクション→アクション」の処理が済むと削除される。

フラッシュの仕組みはセッション機能を利用して実現されているので、ブラウザのクッキーを無効にしていると利用できない。

### 呼び出すテンプレートを指定したいときは？
app/viewsを基点としたパス名を指定する

```rb
def show
  render "another/show"
end
```

### HTMLなどのタグをタグとして出力したいとき
`<%= %>`の代わりに`<%== %>`を使うか、または、html_safeメソッドを用いる。link_toメソッドやimage_tagメソッドのようにタグを生成するメソッドは「.html_safe付きの文字列を返す」という意味で理解しておくと良い。


```rb
# controller.rb

def step10
  @comment = "<strong>安全なHTML</strong>"
end

# view.html.erb
<p><%== @comment %></p>
or
<p><%= @comment.html_safe %></p>
```

### 小数点以下の桁数など文字列や数字の書式を揃えたいときは？

- sprintfメソッドは第一引数に書式を設定し、第二引数以降に書式に並べる変数を並べる。
- sprintfメソッドでは「%文字」の部分に第二引数以降に指定した引数が埋め込まれる。
- よく使われるのは%d(整数)、%f(浮動小数点数)、%s(文字列)
- %3.2fとある場合、全体が３桁で小数点以下が２桁の浮動小数点数を意味する。

```rb
# controller.rb
def step11
  @population = 704414
  @surface = 141.31
end

# view.html.erb
<p>
  <%= sprintf("人口%d人、面積%.0f平方キロ、人口密度%.2f人/平方キロ",
              @population, @surface, @population/@surface) %>
</p>

```

### 日付オブジェクトや日時オブジェクトを文字列に変換するメソッドは？
strftimeメソッド。

```rb
# controller.rb
def step12
  @time = Time.current
end

# view.html.erb
<p><%= @time.strftime("%Y/%m/%d(%a) %H:%M:%S") %></p>

# RESULT
2018/11/20(Tue) 01:08:17
```

### ３桁ごとにカンマを入れて数値を表示させたいときは？
number_with_delimiterを使う

```rb
# controller.rb
def step13
  @population = 127767944
end

# view.html.erb
<p>人口<%= number_with_delimiter(@population) %>人</p>

# RESULT
人口127,767,944人
```

### HTML特殊文字を変換したいときは？
hメソッドを使う

```rb
# 例
module LessonHelper
  def tiny_format(text)
    h(text).gsub("\n", "<br />").html_safe
    # hメソッドは「<」→「&lt;」のようにHTML特殊文字を変換する。
  end
end
```

### 指定のパスが現在のベージだったらリンクにしないようにするには？
link_to_unless_currentメソッドを使う。

```rb
<%= link_to_unless_current("Home", root_path) do %>
  <span class="current">Home</span>
<% end %>
```

### 画像にリンクを貼りたいときは？

```rb
<p>
<%= link_to(image_tag("rails.png", size: "64x20",
      alt: "Ruby on Rails", align: "top"),
      "http://rubyonrails.org/") %>
</p>
```

### Rubyのメソッドを使ってタグを出力するには？
tagメソッドやcontent_tagメソッドを使う。

```rb
<%= tag(:br) %>
<%= content_tag(:p, class: "p1") do %>
  こんにちは
<% end %>
```

### レイアウトテンプレートのレンダリングの順番
- アクション用のテンプレートや部分テンプレートをレンダリングした後で、レイアウトテンプレートをレンダリングする。

### レイアウトテンプレートの切り替え方法
- app/views/layoutsディレクトリに「コントローラ名.html.erb」ファイルを作成することで、該当コントローラーのテンプレートになる。
- コントローラーでlayoutsメソッドを使う。引数はlayoutsディレクトにおいたテンプレートファイルから拡張子を除いたもの。
- アクション内でrenderメソッドにlayoutオプションをつけてテンプレートファイル名を指定する。

### タイムゾーンの設定
`config.time_zone = "Tokyo"`を加える
```rb
# config/application.rb
class Application < Rails::Application
  config.load_defaults 5.2
  config.generators.system_tests = nil
  config.time_zone = "Tokyo" # ここ！！
end
```

### マイグレーションファイルあれこれ
- `rails db:migrate VERSION=<バージョン番号>`とするとマイグレーションファイルがバージョン番号で指定した状態まで戻る。
- 現在のマイグレーションファイルのバージョンを確認したい場合は`rails db:migrate:status`とすると確認できる。`up`が付いているものが実行済みのマイグレーション

```rb
# マイグレーション用メソッド

add_coulumn # カラムの追加
rename_column # カラム名の変更
change_column # カラムの型の変更
remove_column # カラムの削除
```
- `change_column`メソッドと`remove_column`メソッドは`change`メソッドの中で使用するとマイグレーションのロールバックができない。
- `change`メソッドでできないロールバックを行いたいときは、代わりに`up`メソッドと`down`メソッドの2つを記述すること
- `up`メソッドにマイグレーションを進める処理を書き、`down`メソッドに取り消す処理を書けば、ロールバックできる。
```rb
class AlterMembers < ActiveRecord::Migration
  def up
    rename_column :members, :name, :nickname
    change_column :members, :sex, :integer, null: false, default: 2
  end

  def down
    rename_column :members, :nickname, :name
    change_column :members, :sex, :integer, null: false, default: 1
  end
end
```

### シードデータ
アプリケーションを本番用のサイトでリリースする際には、サイトを公開する前にデータベースに初期化用のデータを入れておく必要が出てくる。例えば、管理者のアカウント情報や、都道府県の名前など。そうしたデータを**シードデータ**と呼ぶ。
- シードデータはすでに投入されている状態では使えないので、データベースをクリアにしてから投入する。`rails db:migrate:reset db:seed`

### SQLとは違いクエリメソッドは繋げる順番は自由

### ファインダーメソッド
- firstメソッドやlastメソッドなど
- ファインダーメソッドを使用する際はorderメソッドでソート順を指定する。そうしないと、結果が不定になりバグになりうる。

### Railsにおけるリソース
コントローラが扱う対象に名前をつけたもの

### 7つのアクション以外の任意のアクションを追加したいとき
- リソースの集合（例： index, new, create）
```rb
resources :members do
  collection { get "search" }  # メンバー検索
  # 次のように書いても意味は同じ
  # get "search", on: :collection
end
```
- 個別のリソース(例： show, edit, update, destroy)
```rb
resources :members do
  member { patch "suspend", "restore" } # メンバーの停止・再開
  # 次のように書いても同じ
  # patch "suspend", "restore", on: :member
end
```

### オブジェクトでパスを表す
- link_toメソッドの第２引数にモデルオブジェクトを渡すと「members/:id」のようにmembers_pathメソッドと同じになる。
```rb
link_to member.name, @member
link_to "削除", @member, method: :delete
```
- editアクションやsuspendアクションのように個別のリソースを扱うアクションは配列を使って[:アクション名, オブジェクト]で表せる
```rb
link_to "編集", [:edit, @member]
link_to "停止", [:suspend, @member], method: :patch
```

- indexアクションやnewアクションのようにidパラメータを取らないアクションは「members_path」の「_path」を取りシンボルにしたものが使える
```rb
link_to "会員一覧", :members
link_to "新規追加", :new_member
```

### form_tagメソッド
- 引数には送信先のパスを指定する
- form_tagはデフォルトでHTTPメソッドをPOSTにする

### text_field_tagメソッド
- 第一引数にname属性の値
- 第二引数にvalue属性の値
```rb
<%= form_tag :search_members, method: :get, class: "search" do %>
  <%= text_field_tag "q", params[:q] %>
  <%= submit_tag "検索" %>
<% end %>
```

### &.演算子
```rb
<tr>
  <th>誕生日</th>
  <td><%= @member.birthday&.strftime("%Y年%m月%d日") %></td>
</tr>

# ここで使われる「&.演算子」はbirthdayがnilの場合に備えた書き方。
# そのままstrftimeメソッドを呼び出すと、誕生日がない場合には例外が発生する
# 「&.演算子」は左辺のオブジェクトがnilのときnilを返し、nilでないときは右辺に書かれたメソッドを書き出してその戻り値を返す。
```

### form.checkbox
```rb
<%= form.checkbox :administrator, {}, "on", "off" %>管理者
```
- 第一引数にはモデルの属性、第二引数にはHTMLの属性をハッシュで指定、第三引数と第四引数にはオンの場合とオフの場合の値を並べる
- value属性の値を設定しないと、自動的にオンの値は「1」、オフの値は「0」となる
- 最初からチェックが付いた状態にしたいときは`@member.administrator = true`のようにコントローラでモデルオブジェクトに値を入れておきます。

### form.radio_button
```rb
<%= form.radio_button :sex, 1 %>男
```
- 第二引数にはラジオボタンの値（value属性）を指定
- 最初からチェックがついた状態にしたい場合は`@member.sex = 2`のようにコントローラーで値を入れておく

### form.select
```rb
<% options = ['本町', '東町', '南町', '北町'] %>
<%= form.select :area, options %>

# 生成されるHTMLタグ
<select>
  <option value="本町">本町</option>
  .
  .
  .
  .
</select>
```
- 第二引数には選択肢を配列で指定する
- 最初から選択肢のどれかが選択された状態にしたい場合`@member.area = '東町'`のようにコントローラーで指定する

### form.date_select
```rb
<%= form.date_select :birthday, 
        start_year: 1940, end_year: Time.current.year,
        use_month_numbers: true  %>
```
- オプションとして最初の年（start_year）、最後の年（end_year）、月の表示を数字にするかどうか（use_month_numbers）を指定できる


### モデルのエラーオブジェクトを確認する
- モデルのエラーオブジェクトはerrorメソッドで取り出せる
- エラー情報の内容を見るには、エラーオブジェクトのmessagesメソッドを使う
- エラーの有無は`empty?`で確認できる
```rb
# number属性がnilという設定

>>> member.error.messages
#=> {:number=>["can't be blank"]}
```

### validation例
```rb
# 空を禁止、1以上100未満の整数、会員の間で重複を禁止
  validates :number, presence: true,
    numericality: {
      only_integer: true, # 整数のみ
      greater_than: 0, # 0以上
      lass_than: 100, # 100未満
      allow_blank: true # これがないと、空の背番号を入力した際に「背番号が空」というエラーの他に「背番号が数値ではない」というエラーが発生する
    },
    uniqueness: true
  
  # 空を禁止、半角英数字のみ、文字列の先頭はアルファベット、２文字以上２０文字以下、会員の間で重複を禁止（大文字個女医を区別しない）
  validates :name, presence: true,
    format: { with: /\A[A-Za-z][A-Za-z0-9]*\z/, allow_blank: true },
    length: { minimum: 2, maximun: 20, allow_blank: true },
    uniqueness: { case_sensitive: false }
```

### Emailのvalidationの際に便利なGem
- `email_validator`。このgemを使用する際には以下のようにvalidatesメソッドにemailオプションをつける
```rb
validates :email, email: { allow_blank: true }
# email: trueとしてしまうと空文字が不正なメールアドレスとされてしまうため
# allow_blank: trueとする
```

### エラーメッセージのCSSを変更するには
- モデルオブジェクトにエラーがあるときは、エラーを起こした入力欄はclass属性が"field_with_errors"のdivタグで囲まれる
```css
div.field_with_errors {
  background-color: #fcc;
  padding: 2px;
}
```

### アプリケーションの日本語化
- デフォルトのロケールを日本語に設定する
```rb
# config/application.rb
config.i18n.default_locale = :ja
```

### エラーメッセージを日本語化する
- gemパッケージ`rails-i18n`を使用すると簡単に行える
```rb
gem 'rails-i18n', '~>5.1'
```

### 単数リソースを扱う時のルーティング
- routes.rbの中でresourcesメソッドではなく、単数形のresourceメソッドを使う
`resource :account`

### Railsでセッションデータにアクセスする
- セッションデータに何か値を入れる場合は`session[:データ名] = 値`
```rb
# セッションデータに会員のIDを保存する
session[:member_id] = member.id

# 会員のIDを取り出す
id = session[:member_id]

# ログアウト処理のためにセッションデータを消す
session.delete(:memeber_id)
```

### Railsでパスワード保存の手順
- 平文のパスワードをハッシュ化しハッシュ値で保存するために、Gemパッケージbcryptを有効にする
```rb
gem 'bcrypt', '~> 3.1.7'
```
- ハッシュ値を保存するカラム、password_digestを追加する
```rb
class AlterMembers1 < ActiveRecord::Migration[5.2]
  def change
    add_column :members, :password_digest, :string
  end
end
```
- モデルクラスにhas_secure_passwordメソッドを追加する
```rb
class Member < ApplicationRecord
  has_secure_password
end
# has_secure_passwordメソッドを追加するとできること

#   - 指定のモデルクラスにpasswordおよびpassword_confirmationの2つの属性が追加される
#   password属性には3つのvalidationが設定され、次の3つ。
#   パスワードの存在性、パスワードは72文字以下、パスワードと確認用パスワードは同一

#   - authenticateメソッドが追加される
#   authenticateメソッドは引数として平文のパスワードを取り、
#   それが正しいパスワードであれば、モデルオブジェクト自体を返し、
#   誤っていればfalseを返す。
```

### helper_method
- helper_methodは引数に指定された名前のメソッドをテンプレートの中でも使えるメソッドとして登録する

### form_forのオプション
- urlオプション
```rb
# フォームの送信先のパスとHTTPメソッドを自分で指定したいときurlオプションを利用する
form_for @member, url: member_path(@member), method: :patch
```
- asオプション
```rb
# フォームのパラメーター名を変更したいときasオプションを利用する。次の
# 例ではname属性はname="user[number]"のようになり、コントローラーでは
# params[:user]でデータが取り出せる
form_for @member, as: "user"
```
- htmlオプション
```rb
# formタグにclass属性やid属性を指定したいときはhtmlオプションを利用する
form_for @member, html: {class: "member", id: "main_form"}
```

### controllerメソッド
- controllerメソッドはコントローラオブジェクトを返すメソッド
```rb
# - kind_of?でクラスの種類を調べ、MembersControllerの場合だけ処理を実行する
<% if controller.kind_of?(MembersController) %>
  <処理>
<% end %>
```

### パスワード変更フォームを作成するときのvalidation
- has_secure_passwordメソッドによって追加されるvalidationは新規作成のときしか作動しないので以下のようにする
```rb
attr_accessor :current_password
validates :password, presence: { if: :current_password }
```

### new_recordメソッド
- モデルオブジェクトがデータベースに保存されていない時にtrueを返す。
- 以下の例ではメンバーを新規登録する時だけパスワードの入力欄が表示される
```rb
<% if @member.new_record? %>
    <tr>
      <th><%= from.label :password, "パスワード" %></th>
      <td><%= form.text_field :password %></td>
    </tr>
  <% end %>
```

### advanceメソッドで日時を進める
- 以下の例では現在日時の8日前の3日後、すなわち5日前の日時を返す
```rb
8.days.ago.advance(days: 3)
```

### スコープ
`scope :スコープ名, -> { クエリーメソッド }`
```rb
scope :open_to_the_public, -> { where(member_only: false) }

  scope :visible, -> do
    now = Time.current

    where("released_at <= ?", now).where("expired_at > ? OR expired_at IS NULL", now)
  end
```

### truncateメソッド
- 引数に指定した文字列を任意の指定した長さで区切ることができる。省略記号（...）を加えて返す
```rb

  <%= truncate article.body, length: 80 %>
  <%= link_to "もっと読む", article %>
```

### バリデーションエラーを自分で設定する
```rb
validate do
    # 掲載終了日時が設定されていて、それが掲載開始日時よりも前の時点であればエラーになる
    if expired_at && expired_at < released_at
      # errorsメソッドはエラーオブジェクトを返す
      # さらにaddメソッドを足すと、モデルオブジェクトにバリデーションエラーが登録される
      # addメソッドの第一引数には属性名のシンボル、第二引数にはエラーの種類を示すシンボルを指定する
      errors.add(:expired_at, :expired_at_too_old)
    end
  end
```

### ページネーションの設定方法
- gemを追加する
```rb
gem 'kaminari'
gem 'kaminari-i18n'
```
- kaminariを導入すると、モデルのクエリーメソッドにpageメソッドが追加される
```rb
# pageメソッドには現在のページ数を指定する
# ページリンクにはpageパラメーターがつくのでpageメソッドの引数には params[:page]を指定する
# デフォルトで１ページあたり25件のレコードが取り出されるので、この値を変更したければ、perメソッドで指定する
@members = Member.page(params[:page]).per(10)
```
- テンプレートでpaginateメソッドを使用する
```rb
<%= paginate @members %>
```

### foreign_keyオプションを利用して、外部キーの名前を任意のものにする
```rb
class Car
  has_many :engines, foreign_key: "vehicle_id"
end
-------
class Engine
  belongs_to :car, foreign_key: "vehicle_id"
end
```

### class_nameオプションを利用して、関連付けで使われるメソッド名を変更する
```rb
class Entry
  belongs_to :author, class_name: "Member", foreign_key: "member_id"
  # @entries.memberではなく、@entries.authorで呼び出す
end
```

### dependentオプションを利用して、参照先のレコードを削除した時に参照元のレコードも自動的に削除するようにする
```rb
class Car
  has_many :engines, dependent: :destroy
  # Carレコードを削除すると、結びついているEngineレコードを全て自動的に削除する
end
```

### MySQLやPostgreSQLで外部キー制約を設定するにはforeign_keyオプションを利用する
```rb
class CreateEntries < ActiveRecord::Migration[5.2]
  def change
    create_table :entries do |t|
      t.references :member, null: false, foreign_key: true
    end
  end
end
```

### link_to_ifメソッド
`link_to_if(条件式, 文字列, url [, オプション, HTMLオプション])`

### rescue_fromメソッドを利用して、エラー表示をカスタマイズする
```rb
# application_controller
if Rails.env.production? || ENV["RESCUE_EXCEPTION"]
  rescue_from StandardError, with: :rescue_internal_server_error
  rescue_from ActiveRecord::RecordNotFound, with: :rescue_not_found
  rescue_from ActionController::ParameterMissing, with: :rescue_bad_request
end

private def rescue_not_found(exception)
  render "errors/not_found", status: 404, layout: "error",
    formats: [:html]
end

private def rescue_internal_server_error(exception)
  render "errors/internal_server_error", status: 500, layout: "error",
    formats: [:html]
end
```

### 資格情報を編集する
`rails credentials:edit`
- 本番モードで起動するには、credentials.yml.encにおいてsecret_key_baseというキーに値がセットされていなくてはならない

### 本番モード設定
- 本番モードのための環境変数の設定
`export RAILS_ENV=production`

- キャッシュファイルの生成
`rails assets:precompile`

- 本番用データベースの保護を解除
- `db:setup`はDBの作成、スキーマの読み込み、シードデータの投入という一連の作業を行う
`DISABLE_DATABASE_ENVIRONMENT_CHECK=1 rails db:setup`

### turbolinks
- ブラウザによるページの遷移を高速化する機能

### Active Storageの利用法
- ImageMagickのインストール。画像のサイズを変換できるようになる
`brew install imagemagick`
- ImageMagickを利用するにはmini_magickのインストールが必要
`gem 'mini_magick', '~> 4.8' `
- active_storageのインストール
`rails active_storage:install`
- モデルクラスにクラスメソッド`has_one_attached`を追加する。モデルオブジェクトに対して１個のファイルを添付できるようになる。
`has_one_attached :profile_picture`
- モデルクラスにクラスメソッド`attribute`を追加する。以下はMemberモデルに属性new_profile_pictureを加えている。DBにはnew_profile_pictureカラムはないが、そのようなカラムが存在するかのようにプログラミングできる
```rb
class Member < ApplicationRecord
  # Memberモデルにprofile_picture属性を追加
  has_one_attached :profile_picture
  # Memberモデルにnew_profile_picture属性を追加
  attribute :new_profile_picture
end
```
- new_profile_picture属性は仮想的な属性なため、この属性のデータをprofile_pictureにもセットする必要がある。Memberオブジェクトのprofile_pictureに画像データをセットすると、その瞬間に画像データが保存されてしまい、validationをかけることができなくなる
```rb
before_save do
  if new_profile_picture
    self.profile_picture = new_profile_picture
  end
end
```
- variantメソッドで画像サイズを調整
```rb
  # プロフィール画像が添付されているかどうかの判定
  <% if @member.profile_picture.attached? %>
    <!-- variantは画像データを変換するメソッド。resizeオプションで画像の大きさを調整している -->
    <%= image_tag @member.profile_picture.variant(resize: "128x128") %>
  <% end %>
```

### ファイルアップロード時のバリデーション
```rb
# new_profile_picture属性がnilでもfalseでもない場合だけ、プロック内のコードを実行してバリデーションを行う。
  validate if: :new_profile_picture do
    # respond_toメソッドはあるオブジェクトが特定のメソッドを持っているかどうかを調べてtrueまたはfalseを返す。
    # new_profile_pictureがこのメソッドを持っていない場合はそれがフォームからアップロードされた
    # ファイルデータではないことを示す。
    if new_profile_picture.respond_to(:content_type)
      unless new_profile_picture.content_type.in?(ALLOWED_CONTENT_TYPES)
        errors.add(:new_profile_picture, :invalid_image_type)
      end
    else
      errors.add(:new_profile_picture, :inavalid)
    end
  end
```

### 添付ファイルの削除
- `attribute`メソッドで仮想的な属性を追加。booleanを指定していることにより、送られてきた値は全て真偽に変換される。
```rb
attribute :remove_profile_picture, :boolean
```
- purgeメソッドを使って削除
```rb
before_save do
  if new_profile_picture
    self.profile_picture = new_profile_picture
  elsif remobe_profile_picture
    self.profile_picture.purge
  end
end
```

### link_to_unlessメソッド
- 第一引数の値が真であれば残りの引数をlink_toメソッドに渡してaタグを生成する
```rb
<%= link_to_unless image.first?, "上へ", move_higher_entry_image_path(@entry, image),
            method: :patch %>
```

### sourceメソッドを利用して、関連付けの名前に対象となるモデルの名前以外のものを使う
```rb
class Entry
  has_many :votes, dependent: :destroy
  # entryモデルとmemberモデルの関連付け
  has_many :voters, through: :votes, source: :member
end
```

### namespaceメソッドを利用して、名前空間を導入する
- 引数に名前空間の名前をシンボルで指定し、ブロックの内部でその名前空間に属するルーティングを記述していきます。
```rb
namespace :admin do
  root "top#index"
  # admin_root_pathでURLパス生成
  # link_toの第二引数にシンボルで指定する場合は:admin_root
end
```

## 現場で使える Ruby on Rails 5速習実践ガイド

### slimを使えるようにするには
- Slimジェネレーターを提供してくれる`slim-rails`
- ERB形式のファイルをslim形式に変換してくれるerb2slimコマンドを提供してくれる`html2slim`
```rb
gem 'slim-rails'
gem 'html2slim'
```

### hメソッド
- hメソッドは`&`などのHTMLの特殊文字をエスケープして、`&amp;`などの無害な文字列に変換するメソッド

```rb
td= simple_format(h(@task.description), {}, sanitize: false, wrapper_tag: "div")
```

### simple_format(text, {}, sanitize, wrapper_tag)
- sanitizeオプションをfalseにすると、引数textからタグを除去しない
- wrapper_tagオプションはtextを囲むのに利用する要素名を指定する
```rb
td= simple_format(h(@task.description), {}, sanitize: false, wrapper_tag: "div")
```

### change_column_nullメソッドを利用して、後からNOT NULL制約をつける
```rb
change_column_null :tasks, :name, false
```

### change_columnの場合は自動的にマイグレーションを戻すことができない
- add_columnと異なり、change_columnの場合は自動的にマイグレーションを戻すことができないため以下のように明示する
```rb
class ChangeTasksNameLimit30 < ActiveRecord::Migration[5.2]
  
  def up
    change_column :tasks, :name, :string, limit: 30
  end

  def down
    change_column :tasks, :name, :string
  end
end
```

### セッションとは
- **1つのブラウザから連続して送られている一連のリクエストの間で「状態」を共有できるようにする仕組み**

### Cookieとは
- **複数のリクエストの間で共有したい「状態」をブラウザ側に保存する仕組み**


### RSpecの準備
- gemパッケージ`rspec-rails`をインストール
```
gem 'rspec-rails', '~> 3.7'
```
- generateコマンド
```
bin/rails g rspec:install
```
- testディレクトリを削除
```
rm -r ./test
```

### Capybaraの準備
- spec_helper.rbをいじる
```rb
require 'capybara/rspec'

RSpec.configure do |config|

  config.before(:each, type: :system) do
    driven_by :selenium_chrome_headless
  end
  # rspec-expectations config goes here. You can use an alternate
```

### FactoryBotのインストール
```

```

### 国際化
1. 利用するロケールに対応する翻訳データのymlファイルをconfig/localesの下に配置する
2. 「現在のロケール」を示すI18n.localeが正しく表示された状態にする
    - config/initialezers/locale.rbなどの中で、デフォルト値であるconfig.i18n_localeを適切に設定する
    - rails-i18n
    - 複数の言語を切り替えて利用したいときは、アプリケーションのフィルタなどで、リクエストごとにI18n.localeの値を変更する
3. 目的の翻訳データを利用する
    - I18n.tメソッドを呼ぶことで任意の翻訳データを利用することができる
    - I18n.lメソッドにDate系、Time系のオブジェクトを渡すと、ローカライズされた文字列表現を得ることができる
    - モデルクラスやRailsのヘルパーメソッドが内部的に利用する翻訳データもある

#### ユーザーごとに言語を切り替える
- Userクラスのlocaleという属性に'jp'もしくは'en'を入れるものとする
- I18n.localeの値をリクエストごとに切り替える
```rb
class ApplicationController < ActionController::Base
  before_action :set_locale

  private

  def set_locale
    I18n.locale = current_user&.locale || :ja # ログインしていなければ日本語
  end
```

### 翻訳ファイルの扱い方
- モデルのクラス名の翻訳を`Task.model_name.human`で、属性名の翻訳を`Task.human_attribute_name(:name)`のような方法で取得できる
- より汎用的には`I18n.t`メソッドを使う。ビューでは`t(...)`で呼ぶことができる
```rb
ja:
  taskleaf:
    page:
      titles:
        tasks: "タスク一覧"
```
- 現在のロケールが`:ja`の状態で`I18n.t("taskleaf.page.titles.tasks")`を実行すると"タスク一覧"を取得できる
- `I18n.t("taskleaf.page.titles")`とすれば`titles`以下の設定を`{tasks: "タスク一覧"}`というようなハッシュオブジェクトで取得できる
```rb
# 上のようにlocaleファイルが設定されているとき
```

### 日時の扱い方に関する設定
1. どのタイムゾーンの表現で日時をDBに保存し、読み出し時にどう解釈するか？
    - `config/application.rb`などで`config.active_record.default_timezone`に設定する
2. 1に基づいて取り出した日時データを、どのタイムゾーンのTimeWithZoneオブジェクトとして生成するか。また、ユーザーの入力などに由来する日時データをモデルに代入する際、どのタイムゾーンの時刻であると解釈し、どのタイムゾーンのTimeWithZoneオブジェクトとして生成するか

### アプリケーションのデフォルトのタイムゾーンを日本時間にする
- `config/application.rb`で`config.time_zone`を設定する
```rb
module Taskleaf
  class Application < Rails::Application
    config.load_defaults 5.2
    config.time_zone = 'Asia/Tokyo'
  end
end

```

### コンソールをsandboxモードで起動する
```rb
$ bin/rails c -s
```

### 開発環境で本番用のエラー画面を出して動作確認したい場合
```rb
# config/environments/development.rb
consider_all_requests_local = false
```

### ログを出力するには
- loggerオブジェクトを使う
```rb
def create

  if @task.save
    # 例
    # loggerオブジェクトのdebugメソッドを呼び、ログにタスクの情報をdebugレベルで出力する
    logger.debug "task: #{@task.attributes.inspect}"
    redirect_to @task, notice: "タスクを登録しました"
  end
end
```

### ログレベルの変更
```rb
# config/environments/development.rb
# 以下はwarmレベル以上のログのみを出力
config.log_level = :warn
```

### ログに特定のパラメーターの値を表示しないようにする

```rb
# config/initializers/filter_parameter_logging.rb
Rails.application.config.filter_parameters += [:password]
```

### Rails.csrfToken()関数

### sanitizeメソッド
- HTMLエスケープをスキップできる

### Rubyコードインジェクション
- ユーザーからの入力をそのままsendに渡してはいけない
- 「Kernel.#eval」メソッドにユーザーからの入力を渡してはいけない

### CSP

### Production環境でアプリケーションを立ち上げる
1. アセットのプリコンパイルを行う
    `bin/rails assets:precompile`
2. (Nginxなどを使わないでproduction環境をローカルPCで扱う場合)静的ファイルの配信サーバーを設定する
    - `config/environments/production.rb`の`config.public_file_server.enabled`を変更する。初期状態では、環境変数`RAILS_SERVE_STATIC_FILES`が存在しない限りfalseになるように設定されているので、~/.bash_profileに次のコードを加える`export RAILS_SERVE_STATIC_FILE=1`
3. production環境用のデータベースを作成する
    - DBのユーザーとパスワードを設定する必要がある。
      - （mysqlの場合）
        - `mysql -u root -p`でrootでログイン
        - `create user 'ユーザー名@localhost' identified by 'パスワード'`でユーザー作成

### `credentials.yml.enc`に記述された秘密情報を確認する
- `bin/rails credentials:show`

### `credentials.yml.enc`に記述された秘密情報を編集する
- `bin/rails credentials:edit`

### アプリケーションからcredentialsを参照する
- コンソール上で次のように打つ`Rails.application.credentials.aws`

### ransackを使って検索機能を実装する

#### controller側
- `ransack(params[:q])`でフォーム情報を取得
- `result(distinct: true)`で取得した情報をソート
- ransackを利用する際はセキュリティ上の観点から検索に利用して良いカラムの範囲を制限しておく

#### model側
- `ransackable_attributes`を利用すると、検索対象にすることを許可するカラムを指定できる。デフォルトでは全てのカラムが対象
- `ransackable_associations`は検索条件に含める関連を指定できる。このメソッドを空の配列を返すようにオーバーライドすることで、検索条件に意図しない関連を含めないようにすることができる。
```rb
class Task < ApplicationRecord
  def self.ransackable_attributes(auth_object = nil)
    %w[name created_at]
  end

  def self.ransackable_associations(auth_object = nil)
    []
  end
end
```

#### view側
- フォームでは`form_for`の代わりに`search_form_for`
- フィールド名は`search_field`
- パラメータ名に`_cont`(containsの略)という検索マッチャーをつけると、検索文字列を含むものを検索する。name_contと検索することで、nameに検索文字列を含むものを検索してくれる
- パラメータ名に`_gteq`(greater than or equalの略)という検索マッチャーをつけると、「該当の項目がフォームに入力した値と同じか、それより大きいこと」を条件に検索する。
- ヘルパーメソッド`sort_link`を利用して、第一引数にコントローラでransackメソッドを呼び出して得られたRansack::Searchオブジェクト、第二引数にはソートを行う対象のカラムをしてすると、ソートできる
```rb
# デフォルトでは降順でソートしたいとき
sort_link(@q, :name, default_order: :desc)
```
```rb
# 基本的には名称でソートし、名称が同じであれば登録日時順にソートする
sort_link(@q, :name, [:name, "created_at desc"])
```

### メイラー

#### メイラーの実装
- `rails g mailer ~Mailer`
- mailメソッドでsubject, to, fromを指定する
- どのメールでもfromを統一したい場合はdefault値を指定する
```rb
class TaskMailer < ApplicationMailer
  default from: 'taskleaf@example.com'

  def creation_email(task)
    @task = task
    mail(
      subject: 'タスク作成完了メール',
      to: 'user@example.com',
      from: 'taskleaf@example.com'
    )
  end
end
```

#### テンプレートの実装
- html形式とtext形式を用意する

#### メール送信処理
- `deliver_now`はメールを即時送信するメソッド
- mailcatcherはsmtpサーバーを立てて、送信されたメールをブラウザ上で確認できるようにしてくれるgem.ターミナルで`gem install mailcatcher`とする
    - `config/environments/development.rb`に以下の記述
      ```rb
      config.action_mailer.delivery_method = :smtp
      config.action_mailer.smtp_settings = { address: '127.0.0.1', port: 1025 }
      ```
- `mailcatcher`とターミナル上で打って起動させておく。
- メール画面を確認したいときは`http://127.0.0.1:1080`にアクセス

#### メイラーのテスト

- typeにmailerを指定
```rb
decribe TaskMailer, type: :mailer do

end
```

### ファイルアップロード

#### ActiveStorageの準備
- `bin/rails active_storage:install`
- `bin/rails db:migrate`
- ファイルの実体を管理する場所を指定する
    - `config/environments/development.rb`（以下は開発環境でlocalに保存する場合）
    ```rb
    config.active_storage.service = :local
    ```
    - `config/storage.yml`で確認

#### モデルに画像を添付する
- 該当モデルに以下の記述を追加。以下は1つのモデルに1つの画像を添付する場合
```rb
has_one_attached :image
```
#### ビュー側
- attached?メソッドによって画像が添付されているか判定する

#### ActiveStorage::Blob
- ファイルの実態をDB外で管理することを前提としており、それ以外の情報である、識別key、ファイル名、Content-Type、ファイルのメタデータ、サイズを管理する

#### ActiveStorage::Attachment
- ActiveStorage::Blobとアプリ内の様々なモデルを関連づける中間テーブルに当たるモデル。

### CSV入出力

#### 導入
- `config/application.rb`で`require 'csv'`とする

#### Export

###### モデル側
```rb
# CSVデータにどの属性をどの順番で出力するかを設定
  def self.csv_attributes
    ["name", "description", "created_at", "updated_at"]
  end

  def self.generate_csv
    # CSV.generateでCSVデータの文字列を生成
    # 生成した文字列がgenerate_csvクラスメソッドの戻り値となる
    CSV.generate(headers: true) do |csv|
      # CSVの１行目としてヘッダを出力。csv_attributeの属性名をそのままヘッダにしている
      # クラスメソッドは同一クラス内であればクラスメソッド名だけで呼び出せる
      csv << csv_attributes
      all.each do |task|
        # allメソッドで全タスクを取得し、１レコードごとにCSVの１行を出力する
        # sendメソッドはレシーバに対して引数で指定したメソッドを実行する
        # ここではtask.nameやtask.descriptionなど
        csv << csv_attributes.map{ |attr| task.send(attr) }
      end
    end
  end
```

###### コントローラ側
```rb
respond_to do |format|
      format.html
      # send_dataメソッドはデータのダウンロードを行う
      format.csv { send_data @tasks.generate_csv, filename: "tasks-#{Time.zone.now.strftime('%Y%m%d%S')}.csv"}
    end
```

###### テンプレート側
```rb
= link_to 'エクスポート', tasks_path(format: :csv), class: 'btn btn-primary mb-3'
```

#### IMPORT

###### モデル側
```rb
def self.import(file)
    # foreachでCSVファイルを１行ずつ読み込む
    # headers: trueの規定により、１行目をヘッダとして無視する
    CSV.foreach(file.path, headers: true) do |row|
      # CSV１行ごとにTaskインスタンスを生成
      # クラスメソッド の中なのでselfがTaskであり、task = newはtask = Task.newと同意
      task = new
      # sliceメソッドは[]のエイリアス。引数で指定した文字列を抜き出して返す
      # taskの各属性に情報を入れ込む
      # to_hashとすることで「属性１の値、属性２の値」というデータを{属性１のヘッダー名　=> 属性１の値...}とすることができる
      task.attributes = row.to_hash.slice(*csv_attributes)
      task.save!
    end
  end
```

###### コントローラ側
```rb
def import
    # アップロードしたファイルの内容を、ログインしているユーザーのタスク群として登録することができる
    current_user.tasks.import(params[:file])
    redirect_to tasks_url, notice: "タスクを追加しました"
  end
```

###### ビュー側
```rb
= form_tag import_tasks_path, multiple: true, class: 'mb-3' do
  = file_field_tag :file
  = submit_tag "インポート", class: 'btn btn-primary'
```

###### ルーティング
```rb
post :import, on: :collection
```
### ページネーション

#### 導入
- `gem 'kaminari'`

#### コントローラ側
```rb
@tasks = @q.result(distinct:true).page(params[:page])
```
#### ビュー側
```rb
= paginate @tasks
# 全データが何件なのかを表す
= page_entries_info @tasks
```
#### kaminariはデフォルトの翻訳ファイルはenなのでロケールをjaに直す必要がある
- config/locale/kaminari.ja.yml
https://github.com/kaminari/kaminari/wiki/Internationalization-and-Locales

#### 動作確認
- コンソール上で。ID名は動作確認で使っているユーザーのID
`user = User.find(1)`
`100.times { |i| user.tasks.create!(name: "サンプルタスク#{i}") }`

#### デザインの調整
- 参考：https://github.com/amatsuda/kaminari_themes
- `bin/rails g kaminari:views bootstrap4`

#### 表示件数を変更したいとき
- `@tasks = @q.result(distinct: true).page(params[:page]).per(50)`
- 特定のモデルでデフォルトの表示件数を指定したい場合
```rb
paginates_per 50
```
- 全体としての表示件数のデフォルトを変更する場合
  - `bin/rails g kaminari:config`
  - config/initializers/kaminari_config.rb
    ```rb
    config.default_per_page = 50
    ```

### ActiveJob（Sidekiqを使用）

#### 導入
- キーバリュー型のDBであるRedisをインストール
- `redis-server`でredisのサーバーを起動。起動したままにしおく
- `gem 'sidekiq'`
- `bundle`
- `bundle exec sidekiq`でsidekiqを起動
- config/environments/development.rb
```rb
config.active_job.queue_adapter = :sidekiq
```
- Redisサーバー再起動

#### ジョブの作成、実行
- `rails g job sample`
- controllerで`SampleJob.perform_later`
- setメソッドを使って実行予約することも可能
  `SampleJob.set(wait_until: Date.tommorrow.noon).perform_later`

### AjaxでRailsサーバと通信する

#### 削除時にページ遷移ではなくAjaxリクエストを発生させる
- link_toメソッドに`remote: true`を指定する。こうすると、自動的にAjaxでサーバーにリクエストする。
- これはrails-ujsの機能
```rb
= link_to '削除', task, method: :delete,remote: true, data: { confirm: "タスク「#{task.name}」を削除しましす。よろしいですか？" }, class: 'btn btn-danger'
```

#### 削除したタスクを非表示にする(ajax:successイベントに応じてタスクを削除する方法)
- Rails(rails-ujs)は、`remote: true`をつけたa要素に対して、Ajax通信が成功した時に`ajas:success`というイベントを発行する。
```js
 document.addEventListener('turbolinks:load', function() {
  // document.querySelectorAll('.delete')で削除リンクの要素群を返している
   document.querySelectorAll('.delete').forEach(function(a) {
     a.addEventListener('ajax:success', function() {
  // parentNodeは要素の親要素を返す。ここでは削除リンクを表すオブジェクトがaという変数に入り、
  // prentNodeで削除リンクの親要素であるtd要素を返す。
       var td = a.parentNode;
       var tr = td.parentNode;
       tr.style.display = 'none';
     });
   });
 });
```

#### 削除したタスクを非表示にする(javascriptのレスポンスを実行してタスクを削除する方法)
- サーバー側で識別できるようにid情報を与える
```rb
- @tasks.each do |task|
  tr id="task-#{task.id}"
```
- レスポンスとして返すjavascriptコードを用意する。
```rb
# app/views/tasks/destroy.js.erb
document.querySelector("#task-<%= @task.id %>").style.display = 'none';

var message = document.createElement('p');
message.innerText = 'タスク「<%= @task.name %>」を削除しました。残りのタスクは<%= Task.count %>件です。';
document.querySelector('table').insertAdjacentElement('beforebegin', message);
```

### Turbolinks
- ページ遷移を高速化する仕組み

#### ブラウザのページ遷移が発生しないことが多くなる問題
- `document.addEventListener('turbolinks:load....'`とする

#### <scrip>はhead要素内に記述すること

#### turbolinksを無効にする
1. (新規アプリケーション)`--skip-turbolinks`オプションをつける
2. （既存のアプリケーション）
    - gemを削除する
    - マニフェストファイルから削除する
    - レイアウトファイルから`data-turbolinks-track:reload`を削除する

### Webpacker

#### 導入
1. 新規アプリケーションの場合
    - `rails new app_name --webpack`として、webpackオプションをつける

2. 既存のアプリケーションに導入する場合
    - `gem 'webpacker'`
    - `bin/rails webpacker:install`
    - Yarnのインストール必須
    - `app/views/layouts/application.html.erb`
    ```rb
      <%= javascript_pack_tag 'application %>
    ```

#### コンパイルの実行
p.349

#### Reactを導入してみる
p.349

### チーム開発時気をつけるべきこと

#### PullRequest時に気をつけること
1. レビュー前にブランチをmasterブランチの最新にrebaseする
  - ローカルのブランチで次の操作をする`git rebase master`
2. レビュー前にmasterブランチをshopsブランチにマージする
  - ローカルのmasterブランチを最新にする`git checkout master` `git pull`
  - shopsブランチでマージを行う`git checkout shops` `git merge master`

### find_or_create_by!メソッド
- 引数に渡した属性で検索を行い、レコードが見つかればそのレコードを返し、見つかれなければ新たなレコードを作成する

### バージョンアップ

#### bundle updateをこまめにする

###### バージョンが上がったgemを確認する

###### バージョンアップ内容が妥当か調査する
- gemのリポジトリをGithubで確認する。

###### バージョンアップの内容に問題があった場合はgemのバージョンを戻す
- バージョンアップに問題があったら一時的に当該gemのバージョンを戻す。
- gemfileでバージョン指定を行い`bundle update`を行う
- その際はバージョンを固定する理由、解除する条件をコメントで残す
- `bundle outdated`コマンドを使うとgemに更新があるか確認できる。

#### マイグレーションファイルはロールバックできるかを確認すること
- `bin/rails db:migrate:redo`コマンドで自分のマイグレーションファイルがバージョンを下げる際に問題が起きないことを確認する

### マイグレーションファイルを一つにまとめるgem「Squasher」


### マイグレーションフィルの注意点


#### マイグレーションファイルが成長し変化するコード（マイグレーションファイルの外側にあるコード）に依存するのは危険

#### 一度にインスタンス化するレコード数に気をつける

#### 失敗時には例外を発生させる

#### スキーマキャッシュの存在を意識する
- マイグレーションファイルでActiveRecordを使うときは必ず`reset_column_information`でスキーマキャッシュを更新する
```rb
class AddFreeShippingToOrders < ActiveRecord::Migration[5.2]

  # たのネームスペースに影響を与えないよう、マイグレーションクラス内にモデルクラスを定義
  # アプリケーションコードに依存しないようにApplicationRecordではなく、ActiveRecord::Baseを継承
  class Order < ActiveRecord::Base
  end

  def up
    add_column :orders, :free_shipping, :boolean, null: false, default: false

    # レコード数を気にする
    # reset_column_information
    Order.find_each do |order|
      # updateは処理に失敗したときfalseを返すので、update!として例外を発生させる
      order.update(free_shipping: true)
    end

  def down
    remove_column :orders, :free_shipping
  end
end
```

### 一度に多くのレコードを操作するときはfind_eachメソッド
- 1000件単位で分割して取得し、ブロック内に記述した処理を実行。1001件のレコードを取得するとすると、1000件取得したらメモリを解放
- 常に主キーによる昇順ソートなので、順番に依存する処理には不向き


### `bundle install`と`bundle updateの違い`
- `bundle install`すると、その時のバージョンがGemfile.lockに記録されロックされる
- そのため、gemがバージョンアップされても自動的に環境に反映されない。
- Gemfileに指定されている範囲でバージョンアップを行いたい場合、`bundle update`を行う

### リファクタリング
- 第一の鍵: 適切な場所にコードを書く
- 第二の鍵: 上手に共通化する
- 第三の鍵: 新しい構造を追加して役割を分担する

#### 第一の鍵-適切な場所にコードを書く

###### モデルに書くべきコードをモデルに寄せる

####### 多少変わった形のparamsからの代入コードをモデルに寄せる
- Userモデルクラスが、ユーザーの郵便番号をデータとして抱えているとする
    - 変更前
    ```rb
    class UsersController < ApplicationController
      def create
        @user = User.new(user_params)
        @user.zip_code = params[:zip1].present? && params[:zip2].present?
         ? [params[zip1], params[:zip2]].join('-') : nil

        if @user.save
          redirect_to user_path(@user)
        else
          @zip1 = params[:zip1]
          @zip2 = params[:zip2]
          render :new
        end
      end

      def edit
        @user = User.find(params[:id])
        @zip1 = @user.zip_code.present? ? @user.zip_code.split('-').first : nil
        @zip2 = @user.zip_code.present? ? @user.zip_code.split('-').last : nil
      end

      def user_params
        params.require(:user).permit(:name,...)
      end
    end
    ```
    - 変更後
    ```rb
    # モデル
    class User < ApplicationRecord
      # 属性の受け取り口を用意する
      attr_writer :zip1, :zip2

      before_validation :set_zip_code

      # セッター？
      def zip1
        @zip1 ||= zip_code.present? ? zip_code.split('-').first : nil
      end

      # セッター？
      def zip2
        @zip2 ||= zip_code.present? ? zip_code.split('-').last : nil
      end

      private
      def set_zip_code
        self.zip_code = zip1.present? && zip2.present? ? [zip1, zip2].join('-') : nil
      end
    end
    ```
    ```rb
    # コントローラー
    class UsersController < ApplicationController
      def create
        @user = User.new(user_params)
        if @user.save
          redirect_to user_path(@user)
        else
          render :new
        end
      end

      def edit
        @user = User.find(params[:id])
      end

      private

      def user_params
        params.require(:user).permit(:zip1, :zip2, :name...)
      end
    end
    ```
####### オブジェクトの内部状態を変更するコードをモデルに寄せる
- 記事のstatusを確認し、下書き(draft)なら記事を公開(published)状態にして公開日時を設定する。下書き状態でなければエラーを出す。
- 期間限定の記事(article.limited == true)の場合は、公開終了日(expires_at)を3ヶ月後の月末に設定する。
  - 変更前
  ```rb
  class ArticlesController < ApplicationController
    def publish
      unless @article.status == 'draft'
        redirect_to @article, alert: '下書きの記事のみ公開できます'
        return
      end

      @article.status = 'published'
      @article.published_at = Time.current

      if @article.limited?
        @article.expires_at = (@article.published_at + 3.months).end_of_month
      end

      @article.save

      redirect_to @article, notice: '記事を公開しました'
    end
  end
  ```
  - モデルオブジェクトのインスタンス変数に対するメソッド呼び出しが連続しているような箇所は、モデル側に移した方が良い
  - 変更後
  ```rb
  class Article < ApplicationRecord
  # 下書き状態なら公開処理を行う。期間限定記事の場合は公開終了日時の設定をする
    def publish
      return false unless status == 'draft'

      self.status = 'published'
      self.published_at = Time.current

      if limited?
        self.expires_at = (published_at + 3.months).end_of_month
      end

      save
    end
  end
  ```
  ```rb
  class ArticlesContoroller < ApplicationController
    def publish
      if @article.publish
        redirect_to @article, notice: '記事を公開しました'
      else
        redirect_to @article, alert: '下書きの記事のみ公開できます'
      end
    end
  end
  ```

#### 第二の鍵 - 上手に共通化する

###### モデルの共通化

####### 共通機能のモジュールを複数のモデルクラスにMix-inする
- 複数のモデルに「コメントをつけられる機能」持たせたいとする。モジュールに実装し、includeする。
```rb
module Commentable
  extend ActiveSupport::Concern

  included do
    has_many :comments, as: :commentable
  end

  # コメントの操作についてのメソッド群
end
```






### 共通機能のモジュールを複数のモデルクラスにMix-inする

```rb
module Commentable
  # ActiveSupport::Concernモジュールのメソッドを特異メソッド（クラスメソッド）としてミックスインする
  extend ActiveSupport::Concern

  ### ActiveSupport::Concernモジュールのメソッドであるincludeメソッドを特異メソッドとして使っている
  included do
    has_mamy  :comments, as: :commentable
  end
end
```
```rb
class Entry < ApplicationRecord
  include Commentable
end

class Event < ApplicationRecord
  include Commentable
end

### 上記のように書いたことでEntryクラスやEventクラスに直接has_manyを記述したのと同じように動作する
```

### STI(単一テーブル継承)で共通機能を持たせる
- 継承関係にある全体に共通の名前Lessonを階層名(モジュール名)にして、同じフォルダ内にソースコードが並ぶようにしている
```rb
class Lesson::Base < ApplicationRecord
  # この例では継承の根本にあるLesson::Baseと言うクラス名とlessonsと言うテーブル名が
  # 不一致になっているので、次のようにテーブル名を指定する必要がある
  self.table_name = "lessons"
  ...
end
```
```rb
# オンラインの英会話レッスン
class Lesson::Online < Lesson::Base
  ...
end
```
```rb
# 教室でのレッスン
class Lesson::School < Lesson::Base
  ...
end
```
- STIを利用するためには、対応するテーブルにtypeと言うカラムを用意する必要がある

### 全モデルクラスに共通の処理をApplicationRecordに書く

#### AppliationRecordとモデルクラスの間に抽象的なクラスを挟む
- 全てのActiveRecordモデルに共通の処理を与えるのではなく、特定のカテゴリのActiveRecordモデル群にだけ共通の処理を追加したい場合
- 特定のテーブルに紐づかない抽象的なクラスを作って、任意のモデルクラス群に継承することで実現できる。
```rb
class UserContentModel < ApplicationRecord
  # 以下の記述で抽象的なクラスを作ることができる
  # これがないとSTIと解釈される
  self.abstract_class = true
end

class Entry < UserContentModel

end
```

### 共通機能のモジュールを複数のコントローラクラスにMix-inする
```rb
module ImageUploadActions
  def upload_image
    url = ImageUploader
  end

  private

  # 以下のようにすることでinclude際で
  def uploader_options
    raise NotImprementError
  end
end
```

### 基底クラスを追加して共通機能を持たせる
- アクションの追加を行うために継承を用いるのは避けるべき
- アクション以外の共通化の処理のために行う
- コントローラクラスは次の二つに分かれる
  - アクションを実装するコントローラクラス
  - 上記に対して共通処理を提供するだけの、アクションを実装しない基底コントローラクラス

### コントローラを共通化する前にモデルに切り出せないか考える
- 「モデルのレコードを取り出す、見つけ出す」処理は極力モデルに書く
```rb
# app/models/todo.rb
class Todo < ApplicationRecord
  belongs_to :todoable, polymorphic: true

  scope :due_in_week, -> (base_date, week_start_day){
    start_date = base_date.beginning_of_week(week_start_day)
    end_date = base_date.end_of_week(week_start_day)
    where(due_on: start_date..end_date)
  }
end

def self.most_important
  all.max_by{ |t| t.priority + t.volume }
end
```
```rb
# app/controllers/personal_todos_controller.rb(モデル整理後・完成形)
# 個人のtodoリストを管理
class PersonalTodosController < ApplicationController
  def index
    base_date = params[:base_date]&.to_date || Date.current
    @todos = current_user.todos.due_in_week(base_date, current_user.settings.week_start_day)
  end
end
```
```rb
# app/controller/group_todos_controller.rb(モデル整理後・完成形)
# グループのtodoリストを管理
class GroupTodosController < ApplicationController
  def index
    base_date = params[:base_date]&.to_date || Date.current
    @todos = current_group.due_in_week(base_date, current_user.settings.week_start_day)
    @most_important_todo = @todos.most_important
  end
end
```
### パーシャルを作る際はHTML構造の類似性だけでなく、目的の類似性に着目する

### 書き方に注意する
```rb
# 悪い例
<% @comment.each do |comment| %>
  <%= render partial: 'comment', locals: { comment: @comment } %>
```
```rb
# 良い例
<%= render partial: 'comment', collection: @comments %>
```

### アクションごとにレイアウトを変更したい場合
- コントローラーのクラスメソッド「layout」でレイアウトを指定する
- 「render」メソッドのオプション「:layout」でレイアウトを指定する

### 共通処理を担当するオブジェクトを別に作って連携させる
- 次の例では、ECアプリにおいて、注文（Orderクラス）と商品(Product)クラスがそれぞれ、共通処理を独立させたTaxCalclulatorクラスを使って消費税計算をしている。
```rb
class TaxCalculator
  def self.with_tax(amount, on: date)
    # 指定された日の消費税率で金額を計算して結果を返す
  end
end
```
```rb
class Order < ApplicationRecord
  def tax_included_amount
    TaxCalculator.with_tax(amount, on: created_on)
  end
end
```
```rb
class Product < ApplicationRecord
  def tax_included_unit_price(date)
    TaxCalculator.with_tax(unit_price, on: date)
  end
end
```

#### 意味のあるパラメーターの集合からクラスを生み出す

#### 外部サービスのロジックを閉じ込める

#### 複数のモデルが絡む特定処理の専門家を作る

#### サブリソース単位でコントローラーを分割する

## パーフェクトRuby on Rails

### 「!」付きメソッドとバリデーション
- 「!」を伴わないメソッドはバリデーション失敗時には例外を返さない
- 「!」を伴うメソッドはバリデーション失敗時には例外が起こる

### gsubでブロックを使った置換
- `文字列.gsub(パターン){|ブロック変数| 処理}`
- パターンにマッチする部分を取り出して、ブロックを繰り返し実行する
- マッチした部分はブロックの戻り値に置きかわり、新しい文字列が返る。
```rb
# 名前にCatが含まれていた場合、"lovely Cat"に置き換える
# 本の名前を保存する前に行いたい処理
  before_validation do |book|
    book.name = book.name.gsub(/Cat/) do |matched|
      "lovely #{matched}"
    end
  end
```

### コールバックを起動する条件の設定
- ifオプションやunlessオプションを使う
```rb
after_destroy :if => high_price? do |book|
    Rails.logger.warn "Book with high price is deleted: #{book.attributes.inspect}"
    Rails.logger.warn "Please check!!"
  end
```

### enum
- enumメソッドの引数としてカラム名と文字列化かシンボルの配列を渡す
`enum status: %w(reservation now_on_sale end_of_print)`
- 明示的に数字を指定したい場合
`enum status: { reservation: 0, now_on_sale: 1, end_of_print: 2 }`

### コールバックのスキップ
`skip_before_action`
`skip_after_action`

### rescue_from
- 特定の例外を特定の処理に結びつけたい場合
```rb
class LoginFailed < StandardError
end

class ApplicationController < ActionController::Base
  rescue_from LoginFailed, with: :login_failed

  def login_failed
    render template: 'shared/login_failed', status: 401
  end
end
```

### variants
- 条件によってテンプレートを切り替える機能
- controller内で`request.variants`に`:tablet`や`:mobile`などの値を入力すると、viewは「index.html+tablet.erb」や「index.html+mobile.erb」のように「"+"とrequest.variantの値」のテンプレートが表示される
- 以下の例ではApplicationController内のbefore_actionでUserAgentなどを参照して`request.varint`の値を設定する。
```rb
class ApplicationController
  before_action :detect_mobile_variant


  private
  def detect_mobile_variant
    request.variant = :mobile if request.user_agent = /iPhone/
  end
end
```

### rawメソッド
- 意図的にタグを含んだ文字列を構築してそのまま表示させたい場合に使う
- 内部で`html_safe`メソッドを呼んで、StringオブジェクトをActiveSupport::SafeBufferのオブジェクトに変換している。

### JSONの構築
- 例
```rb
class BooksController < ApplicationController
  def show
    @book = Book.find(params[:id])
    respond_to do |format|
      format.json
    end
  end
end
```
- jbuilderを利用している場合、`app/views/books/show.jbuilder.json`というファイルをテンプレートとして使う
- json.extract!の参考記事:
 https://qiita.com/ryouzi/items/06cb0d4aa7b6527b3645
https://www.rubydoc.info/github/rails/jbuilder/Jbuilder:extract!
- `json.extrack! オブジェクト　属性名1, 属性名2,..`と渡してやると、JSON形式のデータを作成する。
- 「!」をつけないと、そのままキーになる
- ネストさせたい場合はブロックを使う
```rb
# 例
json.extract! @book, :id, :price, :created_at
json.name_with_id "#{@book.id} - #{@book.name}"
json.publisher do
  json.name @book.publisher.name
  json.address @book.publisher.address
end
unless @book.high_price?
  json.low_price true
end
```

### Sprocketsの作り方
- `config.ru`に以下の記述
```rb
require 'sprockets'

map '/assets' do
  # /assets以下にアクセスが来た場合、以下の処理を実行
  environment = Sprockets::Environment.new
  # appeng_pathで管理するディレクトリを追加
  environment.append_path 'assets/javescripts'
  environment.append_path 'assets/stylesheets'
  run environment
end

# これは確認用？
map '/' do
  run Proc.new {|env| [200, { "Content-Type" => "text/html" }, ["Hello, world"]]}
end
```
- Rackを起動する`bundle exec rackup`

### 新しく作成したディレクトリを、アセットパスに追加したい
- `config/application.rb`で以下のように記述
```rb
# Railsプロジェクト直下にある「component」というディレクトリを新しくアセットパスに追加したい
class Application < Rails::Application
  config.assets.path << Rails.root.join('components')
end
```

### プリコンパイル対象を新しく追加したい
- `config/environments/production.rb`
```rb
# search.jsというマニフェストファイルを新しく追加する場合
config.assets.precompile += %w( search.js )
```

### jquery-turbolinks?

### あるディレクトリをオートロードする
- `config/application.rb`に以下の記述をする
```rb
# libディレクトリ配下のsampleディレクトリをオートロードする
class Application < Rails::Application
  config.autoload_paths += %W(#{config.root}/lib/sample)
end
```

### モデルとビューを橋渡しするactive_decorator
- `gem 'active_decorator'`
- `rails g decorator モデル名`
- `モデル名_decorator.rb`でメソッドを定義することで、モデルに関連づいたメソッドをビューで使える
- 以下のモデルオブジェクトしか使用できない
    - コントローラで作成され、ビューに渡されたモデルオブジェクト
    - renderメソッドのlocalオプションに渡されたモデルオブジェクト

### sidekiq
- sidekiqはrailsとは別にプロセスを立ち上げ、そのプロセスがrailsからのメッセージを受け取り、ワーカークラスに引き渡すことで非同期処理を実現する
- 非同期処理のディスパッチャとなるワーカークラスを「app/workers」ディレクトリに配置して管理することを推奨している。
- redisを起動しておく`redis-server`
- `gem sidekiq`
- `bundle`
- workersディレクトリとワーカークラスを作成`mkdir app/workers`
```rb
class CountUpWorker
  # includeすることでワーカーとして動作するクラスを定義できる
  include Sidekiq::Worker

  # ワーカクラスにはperformメソッドが必要
  # performメソッドに実行したい非同期処理を記述する
  def perform(引数)
    # 処理
  end
end
```
- sidekiqを起動`bundle exe sidekiq`

### Better Errorsでエラー画面をリッチにする
- `better_errors`と`binding_of_caller`
- 非同期処理などエラー画面が表示されないケースで例外が発生した場合、/_better_errorsにアクセスすることで最後に発生したBetter Errorsのエラー画面を参照できる。

### springサーバによる不具合の場合
- `spring status` で状態確認
- `spring stop` でspringサーバーを終了させる

### rails-erdでモデルのER図を生成する
- Graphvizというグラフ描画ツールを使用しているため、あらかじめインストール`brew install graphviz`
- gemパッケージをインストール`gem 'rails-erd'`
- `rake erd`


## その他

### 環境構築の手順(2018/11/04)

- Xcodeのインストール(AppStoreから)

- コマンドラインデベロッパーツールのインストール

ターミナルで以下のコマンドを記述

```terminal
$ xcode-select --install
```

- Homebrewのインストール（サイトから）

サイトに載ってるインストール用のコマンドを自分のターミナルで打つ


- rbenvとruby-buildのインストール

ターミナルで以下のコマンドを打つ

```terminal
$ brew install rbenv ruby-build
$ echo 'eval "#(rbenv init -)"' >> ~/.bash_profile
$ source ~/.bash_profile
```

- Rubyのインストール

```terminal
$ rbenv install 2.5.1
$ rbenv global 2.5.1

* 新しいバージョンが出た場合
$ brew upgrade ruby-build
$ rbenv install 2.5.1
$ rbenv global 2.5.2

* rbenv install -l
* rbenv local 2.4.1
```

- Railsのインストール

```terminal
gem install rails --version "5.2.0" -N
* Nオプションはインストール時のドキュメントの生成をキャンセルし、インストールの所要時間を短くする
```

- rails newコマンドでアプリケーションの作成

バージョン指定をしたい場合は以下のようにする

```terminal
rails _5.1.2_ new <アプリ名>
```

- bundle lockコマンドの実行

これを省略するとbundle install時に警告文が出る

```terminal
$ bundle lock --add-platform x64-mingw32 x86-mingw32
```

- bundle installコマンドの実行

### Facebookログイン実装手順

- https://developers.facebook.com/ にアクセス

-  右上のマイアプリから「アプリを追加」を選択

- 新規アプリを作成したら、左にある「設定」から「ベーシック」→「プラットフォームを追加」を選択（サイトURLは開発環境の場合http://localhost:3000）

- railsのgemfileに以下の記述追加

```gemfile
gem 'omniauth'
gem 'omniauth-facebook'
```

- Userモデルにfacebookログイン情報保存用のカラム追加

- config/initializers/devise.rbに以下の記述追加
 
```rb
config.omniauth :facebook, ENV['FACEBOOK_APP_ID'], ENV['FACEBOOK_APP_SECRET'], scope: 'email', info_fields: 'email, name'
# 環境変数は.envで設定済
```

### CarrierWave(gem)使用手順

1.gemをインストール

```
gem 'carrierwave'
gem 'mini_magick'
```

2.bundle実行

3.rails g uploader image をターミナルで実行し、アップローダーを作成

4.app/models/message(仮).rbに以下の記述

```
mount_uploader :image, ImageUploader
```

5.app/uploaders/image_uploader.rbに以下の記述

```
include CarrierWave::MiniMagick
process resize_to_fit: [800,800]
```

※5番目までの処理をしてエラーが出る場合以下の記述をconfig/application.rbに追加

```
config.autoload_paths += Dir[Rails.root.join('app', 'uploaders')]
```

### gem geocoder を使うときに住所を日本語対応にする方法

- ターミナルで以下のコマンドを打つ

```terminal
rails generate geocoder:config

```

- config/initializers/geocoder.rbが生成されるので、以下のように記述

```config/initializers/geocoder.rb
Geocoder.configure(
language: :ja
# 単位をkmにしたい場合
units: :km
)


```

参考：https://github.com/alexreisner/geocoder/blob/master/lib/geocoder/configuration.rb
https://github.com/alexreisner/geocoder/blob/master/lib/geocoder/configuration.rb
http://railscasts.com/episodes/273-geocoder


### request.refererとは

request.refererでリファラーを取得する。リファラーとは該当ページに遷移する直前に閲覧されていた参照元ページのURLのこと

```rb
# room_controller.rb
  redirect_back(fallback_location: request.referer)
```

### renderの部分テンプレートの呼び出しの際の注意点

```rb
前提
@group = Group.find(params[:id])
@messages = (@)group.messages.includes(:user)
部分テンプレート名 : _message.html.haml
```

- （ファイル名に縛りあり）モデルオブジェクトの集合を部分テンプレートで各要素ごとに展開したい場合

```messages/_message.html.erb
render @message
```

- （ファイル名に縛りなし）モデルオブジェクトの集合を部分テンプレートで各要素ごとに展開したい場合

```
render partial: partial/message', collection: @messages
```

### groupに関連するエラーメッセージを表示したい。

```rb

group.errors.full_messages.each do |message|
  <%= message %>
end
```

### toastr表示法

#### application.jsでrequireする時jqueryよりも下に配置しなければならない

```application.js
//= require rails-ujs
//= require turbolinks
//= require_tree .
//= require jquery3
//= require popper
//= require toastr　<--ここ
//= require bootstrap-sprockets
```
#### toastrの最新版は記述内容が旧版と異なる
　　旧版：　https://github.com/tylergannon/toastr-rails

　　新版：https://github.com/CodeSeven/toastr

新版での記述の仕方は以下の通り

```_message.html.rb
<% unless flash.empty? %>
  <script type="text/javascript">
#旧版はflash.each do |key, value|と記述 
    <% flash.each do |f| %>
      <% type = f[0].to_s.gsub('alert', 'error').gsub('notice', 'success') %>
#旧版はtoastr['<%= type %>']('<%= value %>')と記述
        toastr['<%= type %>']('<%= f[1] %>')
    <% end %>
  </script>
<% end %>
```

### テーブル作成の際、references型で外部キーを指定した時のメリット
indexを自動で貼ってくれる。

### リファクタリング

#### 同じ処理を繰り返し書く場合
- before

```books/show.html.erb
<% if user_signed_in? %>
  <% if current_user == @book.user %>
    <%= link_to "編集", edit_book_path(@book) %>
  <% end %>
<% end %>
```

```comments/show.html.erb
<% if user_signed_in? %>
  <% if current_user == @comment.user %>
    <%= link_to "編集", edit_comment_path(@comment) %>
  <% end %>
<% end %>
```
同じ処理が繰り返されており、無駄が多い。


リファクタリングのため、この処理をヘルパーでメソッド化すると簡潔に記述できる。
ファイル特有のインスタンス変数はメソッドの引数とすることで解決。

- after

```helpers/application_helper.rb
def current_user_has?(instance)
  user_signed_in? && current_user == instance.user
end
```
```books/show.html.erb
<% if current_user_has?(@book) %>
   <%= link_to "編集", edit_book_path(@book) %>
<% end %>
```

#### 複雑な条件分岐がある場合

- before

```note.html.erb
<% if @book.published? %>
  <% if @book.popular? %>
    <%=  link_to "詳細", book_path(@book) ,class: "popular" %>
  <% else %>
    <%=  link_to "詳細", book_path(@book) ,class: "normal" %>
  <% end %>
<% else %>
  <div class=normal>閲覧不可</div>
<% end %>
```

これも処理内容をヘルパーで定義すると以下のようになる

- after

```helper.rb
def book_link(book) 
  class_name = book.popular? ? "popular" : "normal"
 if book.published?
    content_tag :a, "詳細", class: class_name
 else
   content_tag :div, "閲覧不可", class: class_name
  end
end
```

```note.html.erb
<%= book_link(@book) %>
```

#### 複数のコントローラーに同じ処理が記述されている場合

controllers/concernsにファイルを追加して、共通するコードをモジュールとして定義し、必要箇所で読み込ませる

- before

```products_controller.rb
class ProductsController < ApplicationController
  before_action :set_cart

  ~ ~ ~ 

  private

  def set_cart
    @cart = Cart.find_by(id: session[:cart_id])
    if @cart.nil?
      @cart = Cart.create
      session[:cart_id] = @cart.id
    end
  end
end
```

```top_controller.rb
class TopController < ApplicationController
  before_action :set_cart

  ~ ~ ~

  private

  def set_cart
    @cart = Cart.find_by(id: session[:cart_id])
    if @cart.nil?
      @cart = Cart.create
      session[:cart_id] = @cart.id
    end
  end
end
```
- after

```rb
# app/controllers/concerns/current_cart.rb
module CurrentCart
  extend ActiveSupport::Concern

  private

  def set_cart
    @cart = Cart.find_by(id: session[:cart_id])
    if @cart.nil?
      @cart = Cart.create
      session[:cart_id] = @cart.id
    end
  end
end
```

```app/controllers/products_controller.rb
class ProductsController < ApplicationController
  include CurrentCart
  before_action :set_cart
end
```

```app/controllers/top_controller.rb
class TopController < ApplicationController
  include CurrentCart
  before_action :set_cart
end
```

#### コントローラに複雑な処理を記述している場合

モデルにコードを切り出す

- before

```rb
# controller
@user = User.find(params[:user_id])
@user.name = params[:user_name]
if params[company_name]
  @user.company_name = params[company_name]
  company = Conpany.find_by(name: params[company_name])
  if company
    @user.company = company
  end
end
@user.save
```

- after

```rb
# controller
@user = User.find(params[:user_id])
@user.update_company(params[company_name])

# model
class User < ActiveRecord::Base
  def update_company(comnapy_name)
    if company_name
      self.company_name = comnapy_name
      company = Conpany.find_by(name: params[company_name])
      if company
        self.company = company
      end
    end
    save
  end
end
```

### マイグレーションファイルをバージョン指定して削除する。

`rails db:migrate:status`でマイグレーションファイルのバージョンを確認。

`rails db:migrate:down VERSION=<バージョン番号>`でマイグレーションファイルをdown状態にする。

`rm db/migrate/<マイグレーションファイル>`でマイグレーションファイルを削除。


### テーブルを削除する

- `rails g migration drop_<削除したいテーブル名>`でマイグレーションファイルを作成(例：photosテーブルを削除する)

- マイグレーションファイルを以下のように編集

```rb
class DropPhotos < ActiveRecord::Migration[5.1]
  def change
    drop_table :photos
  end
end
```

- `rails db:migrate`してテーブル削除完了

### カラムを削除する

- `rails g migration remove_<カラム名>_from_<テーブル名> カラム名:型名`でマイグレーションファイル作成

- 以下のようなマイグレーションファイルが作成される。（例：roomsテーブルからphotoカラムを削除）

```rb
class RemovePhotoFromRooms < ActiveRecord::Migration[5.1]
  def change
    remove_column :rooms, :photo, :string
  end
end
```

- `rails db:migrate`を入力し、完了。

### モデルやルートを簡単に確認する
- `pry-rails`を使うと使えるコマンド
  - `show-models`: 全テーブルを確認できる
  - `show-routes`: 全ルートを確認できる

### fetchメソッド
- `hash.fetch(第一引数, 第二引数)`
- hashから第一引数で指定したキーの値を取り出して返す。
- キーが存在しない場合は、第二引数を返す

### ヘッダー情報を取得
- request.headersを使用
- ipアドレス取得は`request.remote_ip`
- 環境変数取得は`request.env`

### ヘルパーメソッドを自作するときはhメソッドが便利
- `h`メソッドは`>`を`&lt;`のようにHTML特殊文字変換してくれる
- `html_safe`メソッドは自動的に特殊文字変換するのを防ぐ

```ruby
def sample_method(text)
  h(text).gsub("\n", "<br />").html_safe
end
```
